<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hostel Attendance System</title>

    <!-- PWA Features (disabled for local testing) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <link rel="apple-touch-icon" href="hostel_app_icon.png">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- External CSS - Mess Bill Style -->
    <link rel="stylesheet" href="attendance.css">
    <!-- Attendance-specific overrides -->
    <link rel="stylesheet" href="attendance-overrides.css">

    <!-- Session Check - Redirect if not logged in -->
    <script>
        (function () {
            const sheetUrl = localStorage.getItem('messflow_attendance_sheet_url');
            if (!sheetUrl) {
                window.location.replace('welcome.html');
            }
        })();
    </script>

    <!-- Minimal inline overrides -->
    <style>
        /* iOS safe areas */
        @supports (padding: env(safe-area-inset-top)) {
            .top-bar {
                padding-top: calc(12px + env(safe-area-inset-top));
            }

            .sync-bar {
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
            }
        }

        /* Main content padding for bottom bar */
        .main-content {
            padding-bottom: 100px;
        }

        /* Admin panel section */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }
    </style>
</head>


<body>

    <!-- iOS Toast Container (must be direct child of body for proper centering) -->
    <div id="iosToastContainer" class="ios-toast-container"></div>

    <!-- Account Info Modal -->
    <div id="accountInfoOverlay"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; backdrop-filter: blur(4px); animation: fadeIn 0.2s ease;"
        onclick="closeAccountInfo()">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; width: 90%; max-width: 380px; overflow: hidden; animation: slideUp 0.3s ease;"
            onclick="event.stopPropagation()">
            <!-- Header -->
            <div
                style="background: linear-gradient(135deg, #003366 0%, #004a8f 100%); padding: 24px; text-align: center;">
                <div style="width: 70px; height: 70px; background: #FF9933; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 28px; font-weight: 700; color: white;"
                    id="accountInitial">A</div>
                <h2 style="color: white; margin: 0; font-size: 18px;" id="accountHostelName">Hostel Name</h2>
                <p style="color: rgba(255,255,255,0.8); margin: 6px 0 0; font-size: 13px;">Account Information</p>
            </div>

            <!-- Info List -->
            <div style="padding: 16px;">
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">person</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Rector Name</div>
                        <div style="font-size: 15px; color: #333; font-weight: 500;" id="accountRectorName">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">mail</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Email</div>
                        <div style="font-size: 15px; color: #333; font-weight: 500;" id="accountEmail">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">badge</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Hostel ID</div>
                        <div style="font-size: 15px; color: #333; font-weight: 500;" id="accountHostelId">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">home</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Hostel Name</div>
                        <div style="font-size: 15px; color: #333; font-weight: 500;" id="accountHostelNameInfo">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined"
                        style="color: #003366; margin-right: 12px;">location_on</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">City</div>
                        <div style="font-size: 15px; color: #333; font-weight: 500;" id="accountCity">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0; border-bottom: 1px solid #eee;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">link</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Attendance Sheet</div>
                        <div style="font-size: 13px; color: #007AFF; font-weight: 500; word-break: break-all; cursor: pointer;"
                            id="accountSheetUrl" onclick="window.open(this.dataset.url, '_blank')">-</div>
                    </div>
                </div>
                <div style="display: flex; padding: 14px 0;">
                    <span class="material-symbols-outlined" style="color: #003366; margin-right: 12px;">group</span>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #888;">Students Sheet</div>
                        <div style="font-size: 13px; color: #007AFF; font-weight: 500; word-break: break-all; cursor: pointer;"
                            id="accountStudentsUrl" onclick="window.open(this.dataset.url, '_blank')">-</div>
                    </div>
                </div>
            </div>

            <!-- Footer Buttons -->
            <div style="padding: 0 16px 16px; display: flex; gap: 10px;">
                <button onclick="closeAccountInfo()"
                    style="flex: 1; padding: 14px; background: #f5f5f5; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: #333; cursor: pointer;">Close</button>
                <button onclick="handleLogout()"
                    style="flex: 1; padding: 14px; background: #dc3545; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span class="material-symbols-outlined" style="font-size: 18px;">logout</span>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- iOS AssistiveTouch Floating Button -->
    <div id="assistiveTouchBtn" class="assistive-touch-btn">
        <span class="material-symbols-outlined">apps</span>
    </div>

    <!-- AssistiveTouch Menu Overlay -->
    <div id="assistiveTouchOverlay" class="assistive-touch-overlay"></div>

    <!-- AssistiveTouch Menu -->
    <div id="assistiveTouchMenu" class="assistive-touch-menu">
        <div class="assistive-menu-item" data-category="Yoga">
            <div class="assistive-menu-icon">
                <span class="material-symbols-outlined">self_improvement</span>
            </div>
            <span class="assistive-menu-text">Yoga</span>
        </div>
        <div class="assistive-menu-item" data-category="Mess Day">
            <div class="assistive-menu-icon">
                <span class="material-symbols-outlined">restaurant</span>
            </div>
            <span class="assistive-menu-text">Mess Day</span>
        </div>
        <div class="assistive-menu-item" data-category="Mess Night">
            <div class="assistive-menu-icon">
                <span class="material-symbols-outlined">bedtime</span>
            </div>
            <span class="assistive-menu-text">Mess Night</span>
        </div>
        <div class="assistive-menu-item" data-category="Night Shift">
            <div class="assistive-menu-icon">
                <span class="material-symbols-outlined">nights_stay</span>
            </div>
            <span class="assistive-menu-text">Night Shift</span>
        </div>
    </div>

    <!-- iOS Authentication Sheet -->
    <div id="iosAuthOverlay" class="ios-auth-overlay">
        <div class="ios-auth-sheet">
            <div class="ios-auth-icon">
                <span class="material-symbols-outlined">lock</span>
            </div>
            <h2 class="ios-auth-title">Authentication Required</h2>
            <p class="ios-auth-subtitle">Enter password to access Admin Panel</p>
            <div class="ios-auth-input-container">
                <input type="password" id="iosAuthPassword" class="ios-auth-input" placeholder="Password"
                    autocomplete="off">
            </div>
            <div class="ios-auth-error" id="iosAuthError">Incorrect password. Try again.</div>
            <div class="ios-auth-buttons">
                <button class="ios-auth-btn cancel" onclick="closeIOSAuth()">Cancel</button>
                <button class="ios-auth-btn unlock" onclick="submitIOSAuth()">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Multi-Device Sync Status Banner -->
    <div id="syncStatusBanner" class="sync-status-banner" style="display: none;">
        <div class="sync-banner-content">
            <span class="material-symbols-outlined sync-banner-icon">cloud_done</span>
            <span class="sync-banner-text" id="syncBannerText">Attendance already submitted</span>
        </div>
        <button class="sync-banner-dismiss" onclick="dismissSyncBanner()">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>

    <!-- Navigation Drawer -->
    <div class="drawer-overlay" id="drawerScrim" onclick="closeDrawer()"></div>
    <nav class="nav-drawer" id="navDrawer">
        <div class="drawer-header" onclick="openAccountInfo(); closeDrawer();" style="cursor: pointer;"
            title="View Account Info">
            <span class="material-symbols-outlined">school</span>
            <span id="hostelNameDisplay">Attendance</span>
            <span class="material-symbols-outlined"
                style="margin-left: auto; font-size: 20px; opacity: 0.7;">chevron_right</span>
        </div>

        <div class="drawer-content">
            <div class="drawer-label">Shifts</div>

            <a class="drawer-item active" onclick="switchCategory('Yoga')" id="nav-Yoga">
                <span class="material-symbols-outlined">self_improvement</span>
                Yoga
                <span id="nav-indicator-Yoga" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Mess Day')" id="nav-Mess Day">
                <span class="material-symbols-outlined">restaurant</span>
                Mess Day
                <span id="nav-indicator-Mess Day" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Mess Night')" id="nav-Mess Night">
                <span class="material-symbols-outlined">bedtime</span>
                Mess Night
                <span id="nav-indicator-Mess Night" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Night Shift')" id="nav-Night Shift">
                <span class="material-symbols-outlined">nights_stay</span>
                Night Shift
                <span id="nav-indicator-Night Shift" style="margin-left: auto; font-size: 18px;"></span>
            </a>

            <div class="drawer-divider"></div>
            <div class="drawer-label">Actions</div>

            <a class="drawer-item" onclick="openAddStudentModal()" style="color: var(--md-sys-color-primary);">
                <span class="material-symbols-outlined">person_add</span>
                Add Student
            </a>
            <a class="drawer-item" onclick="resetAttendance()">
                <span class="material-symbols-outlined">restart_alt</span>
                Reset Current
            </a>
            <a class="drawer-item" onclick="downloadAttendance()">
                <span class="material-symbols-outlined">download</span>
                Download CSV
            </a>
            <a class="drawer-item" onclick="openQuickDailyReportDialog()">
                <span class="material-symbols-outlined">cloud_download</span>
                Quick Daily Report
            </a>

            <a class="drawer-item" onclick="openAdminLogin()">
                <span class="material-symbols-outlined">admin_panel_settings</span>
                Admin Panel
            </a>
            <a class="drawer-item" onclick="openSyncTracker()" style="color: var(--md-sys-color-tertiary);">
                <span class="material-symbols-outlined">analytics</span>
                Sync Tracker
            </a>

            <div class="drawer-divider"></div>
            <div class="drawer-label">Settings</div>

            <a class="drawer-item" onclick="toggleTheme()">
                <span class="material-symbols-outlined" id="themeIcon">dark_mode</span>
                <span id="themeText">Dark Mode</span>
            </a>
            <a class="drawer-item" onclick="handleLogout()" style="color: #FF3B30;">
                <span class="material-symbols-outlined">logout</span>
                Logout
            </a>
        </div>
    </nav>

    <!-- App Root - Centers content like Mess Bill -->
    <div id="app-root">
        <!-- iOS Top Bar - Mess Bill Style -->
        <div class="top-bar">
            <div class="search-pill" id="searchPill">
                <button class="icon-btn" onclick="openDrawer()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <input type="text" class="search-input" id="studentSearch" placeholder="Search students...">
                <div class="avatar" onclick="openAccountInfo()" id="userAvatar" title="Account Info">A</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="content" id="mainContent">

            <!-- Hero Stats Card - Like Mess Bill THIS MONTH -->
            <div class="card stats-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-size: 13px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;"
                            id="headerTitle">YOGA</div>
                        <div style="font-size: 36px; font-weight: 800; margin-top: 4px;" id="presentCount">0</div>
                        <div style="font-size: 14px; opacity: 0.85;" id="headerDate">Present Today</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 13px; font-weight: 600; opacity: 0.9; text-transform: uppercase;">ABSENT
                        </div>
                        <div style="font-size: 28px; font-weight: 700; margin-top: 4px;" id="absentCount">0</div>
                        <div style="font-size: 13px; opacity: 0.85;" id="leaveCountLabel">Leave: <span
                                id="leaveCount">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Date Picker - iOS Style -->
            <div class="ios-date-picker">
                <span class="material-symbols-outlined">calendar_today</span>
                <input type="date" class="ios-date-input" id="attendanceDate">
            </div>

            <!-- Verification Toggle - iOS Style -->
            <div class="ios-verification-row" id="verificationCard" onclick="toggleVerification()">
                <span class="ios-verification-text" id="verifyText">Mark as Verified</span>
                <div class="ios-toggle-switch" id="verifyToggle">
                    <div class="ios-toggle-knob"></div>
                </div>
            </div>

            <!-- Fetch from Database Button (only visible for past dates) -->
            <div id="fetchButtonContainer" style="display: none; margin-bottom: 12px;">
                <button onclick="fetchCurrentSectionFromDB()" style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--md-sys-color-primary); 
                        background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(88,86,214,0.08) 100%); 
                        color: var(--md-sys-color-primary); font-size: 15px; font-weight: 600; 
                        display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
                        font-family: inherit;">
                    <span class="material-symbols-outlined" style="font-size: 20px;">cloud_download</span>
                    Fetch <span id="fetchCategoryName">Yoga</span> from Database
                </button>
                <div id="fetchStatusText"
                    style="text-align: center; font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 6px;">
                </div>
            </div>

            <!-- Section Title -->
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span>STUDENTS</span>
                <span id="totalStudentsCount" style="font-size: 13px; color: var(--ios-text-tertiary);">0 total</span>
            </div>

            <!-- Student List -->
            <div id="studentList" class="student-list-container">
                <div class="student-card" style="justify-content: center; color: var(--ios-text-tertiary);">
                    No data loaded. Upload CSV to begin.
                </div>
            </div>

        </main><!-- End main.content -->
    </div><!-- End #app-root -->

    <!-- iOS Dock Bar - Single Glass Container -->
    <div class="ios-dock-bar">
        <div class="ios-dock-glass">
            <button class="ios-dock-item" onclick="openQuickDailyReportDialog()" title="Report">
                <span class="material-symbols-outlined">download</span>
                <span class="ios-dock-text">Report</span>
            </button>
            <button class="ios-dock-item" onclick="openSyncTracker()" title="Tracker">
                <span class="material-symbols-outlined">analytics</span>
                <span class="ios-dock-text">Tracker</span>
            </button>
            <button class="ios-dock-item" onclick="syncCurrentSection()" title="Section">
                <span class="material-symbols-outlined">cloud_upload</span>
                <span class="ios-dock-text">Section</span>
            </button>
            <button class="ios-dock-item" onclick="syncToGoogleSheet()" title="Sync All">
                <span class="material-symbols-outlined">cloud_sync</span>
                <span class="ios-dock-text">Sync All</span>
            </button>
        </div>
    </div>

    <!-- iOS Toast Container moved to top of body for proper centering -->

    <!-- iOS Loading Overlay (hidden by default) -->
    <div id="iosLoadingOverlay" class="ios-loading-overlay" style="display:none;">
        <div class="ios-loading-box">
            <div class="ios-spinner"></div>
            <div class="ios-loading-text" id="iosLoadingText">Processing...</div>
        </div>
    </div>

    <div id="messageArea"></div>

    <!-- Add Student Modal -->
    <div id="addStudentModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--md-sys-color-surface); border-radius:24px; padding:24px; width:90%; max-width:400px; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                <span class="material-symbols-outlined"
                    style="color:var(--md-sys-color-primary); font-size:28px;">person_add</span>
                <h2 style="margin:0; font-size:20px; color:var(--md-sys-color-on-surface);">Add New Student</h2>
            </div>

            <div style="display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="newStudentName" placeholder="Full Name *"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAppNumber" placeholder="Application Number"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAppId" placeholder="Application ID"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentHostelId" placeholder="Hostel ID"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAllocation" placeholder="Hostel Allocation (Room/Block)"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
            </div>

            <div id="addStudentError"
                style="color:var(--md-sys-color-error); font-size:14px; margin-top:12px; display:none;"></div>

            <div style="display:flex; gap:12px; margin-top:20px; justify-content:flex-end;">
                <button onclick="closeAddStudentModal()"
                    style="padding:12px 24px; border-radius:20px; border:none; background:transparent; color:var(--md-sys-color-primary); font-weight:500; font-size:14px; cursor:pointer;">
                    Cancel
                </button>
                <button onclick="saveNewStudent()"
                    style="padding:12px 24px; border-radius:20px; border:none; background:var(--md-sys-color-primary); color:var(--md-sys-color-on-primary); font-weight:500; font-size:14px; cursor:pointer;">
                    Add Student
                </button>
            </div>
        </div>
    </div>

    <!-- Sync Tracker Modal -->
    <div id="syncTrackerModal" class="sync-tracker-modal">
        <div class="sync-tracker-header">
            <button onclick="closeSyncTracker()" style="background:none; border:none; cursor:pointer; padding:8px;">
                <span class="material-symbols-outlined" style="color:var(--md-sys-color-primary);">arrow_back_ios</span>
            </button>
            <h2>ðŸ“Š Sync Tracker</h2>
        </div>
        <div class="sync-tracker-content">
            <!-- Date Range Pills -->
            <div class="date-range-pills" style="flex-wrap: wrap;">
                <button class="date-range-pill active" onclick="setTrackerRange(7)">7 Days</button>
                <button class="date-range-pill" onclick="setTrackerRange(30)">30 Days</button>
                <button class="date-range-pill" onclick="setTrackerRange(90)">3 Months</button>
                <button class="date-range-pill" onclick="setTrackerRange(180)">6 Months</button>
                <button class="date-range-pill" onclick="showCustomDatePicker()">Custom</button>
            </div>

            <!-- Custom Date Picker (hidden by default) -->
            <div id="customDatePicker"
                style="display:none; margin-bottom:16px; padding:12px; background:var(--md-sys-color-surface-variant); border-radius:12px;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label style="font-size:13px; color:var(--md-sys-color-on-surface-variant);">From:</label>
                    <input type="date" id="trackerStartDate"
                        style="padding:8px 12px; border-radius:8px; border:1px solid var(--md-sys-color-outline); background:var(--md-sys-color-surface); color:var(--md-sys-color-on-surface); font-size:14px;">
                    <label style="font-size:13px; color:var(--md-sys-color-on-surface-variant);">To:</label>
                    <input type="date" id="trackerEndDate"
                        style="padding:8px 12px; border-radius:8px; border:1px solid var(--md-sys-color-outline); background:var(--md-sys-color-surface); color:var(--md-sys-color-on-surface); font-size:14px;">
                    <button onclick="applyCustomDateRange()"
                        style="padding:8px 16px; border-radius:8px; border:none; background:var(--md-sys-color-primary); color:white; font-size:13px; font-weight:500; cursor:pointer;">Apply</button>
                </div>
            </div>

            <!-- Sync Status Grid -->
            <table class="sync-tracker-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>ðŸ§˜<br><span style="font-size:9px;">Yoga</span></th>
                        <th>ðŸŒ…<br><span style="font-size:9px;">Mess Day</span></th>
                        <th>ðŸŒ™<br><span style="font-size:9px;">Mess Night</span></th>
                        <th>ðŸŒƒ<br><span style="font-size:9px;">Night Shift</span></th>
                        <th>âœ“<br><span style="font-size:9px;">All</span></th>
                    </tr>
                </thead>
                <tbody id="syncTrackerBody">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>

            <!-- Summary Card -->
            <div class="sync-summary-card">
                <div class="sync-summary-title">
                    <span class="material-symbols-outlined" style="font-size:18px;">trending_up</span>
                    Weekly Summary
                </div>
                <div class="sync-progress-bar">
                    <div class="sync-progress-fill" id="syncProgressFill" style="width: 0%;"></div>
                </div>
                <div class="sync-summary-stats" id="syncSummaryStats">
                    0% Complete â€¢ 0/0 Days Synced
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard Modal -->
    <div id="studentDashboardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; justify-content:center; align-items:center; padding:16px;">
        <div
            style="background:var(--md-sys-color-surface); border-radius:24px; padding:24px; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined"
                        style="color:var(--md-sys-color-primary); font-size:28px;">analytics</span>
                    <div>
                        <h2 id="dashboardStudentName"
                            style="margin:0; font-size:18px; color:var(--md-sys-color-on-surface);"></h2>
                        <div id="dashboardCategory"
                            style="font-size:12px; color:var(--md-sys-color-on-surface-variant);"></div>
                    </div>
                </div>
                <button onclick="closeStudentDashboard()"
                    style="background:none; border:none; cursor:pointer; padding:8px;">
                    <span class="material-symbols-outlined"
                        style="color:var(--md-sys-color-on-surface-variant);">close</span>
                </button>
            </div>

            <!-- Summary Stats - iOS Style -->
            <div style="display:flex; gap:12px; margin-bottom:20px;">
                <div
                    style="flex:1; background:white; padding:16px; border-radius:12px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="font-size:28px; font-weight:700; color:#34C759;" id="dashPresent">0</div>
                    <div style="font-size:13px; color:#8E8E93; margin-top:4px;">Present</div>
                </div>
                <div
                    style="flex:1; background:white; padding:16px; border-radius:12px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="font-size:28px; font-weight:700; color:#FF3B30;" id="dashAbsent">0</div>
                    <div style="font-size:13px; color:#8E8E93; margin-top:4px;">Absent</div>
                </div>
                <div
                    style="flex:1; background:white; padding:16px; border-radius:12px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="font-size:28px; font-weight:700; color:#FF9500;" id="dashLeave">0</div>
                    <div style="font-size:13px; color:#8E8E93; margin-top:4px;">Leave</div>
                </div>
            </div>

            <!-- Date Details Sections -->
            <div id="dashboardDateDetails"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
        // --- State & Config ---
        let students = [];
        let attendanceByCategory = {};
        let attendance = {};
        let currentCategory = 'Yoga';
        let csvData = [];
        let loadedFromSheets = {};
        let studentSearchQuery = '';
        let verifiedCategories = {};
        let syncedCategories = {}; // Track which date+category has been synced
        const CATEGORIES = ['Yoga', 'Mess Day', 'Mess Night', 'Night Shift'];
        const STORAGE_KEY = 'hostel_attendance_saved_v2';
        const SYNC_STATUS_KEY = 'hostel_sync_status_v1';
        const LAST_STATE_KEY = 'hostel_last_state_v1';
        let GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJPEjercwwzZDQJxdphKO2wiaD4nf_idvAiGnzwlC8YN4O6UOav2nR6humJGM_kJ1vbQ/exec';
        let autoSaveTimeout = null;
        let hasUnsyncedChanges = false; // Track if there are unsynced attendance changes

        // --- MULTI-HOSTEL SAAS SESSION MANAGEMENT ---
        const SESSION_KEYS = {
            HOSTEL_ID: 'messflow_hostel_id',
            HOSTEL_NAME: 'messflow_hostel_name',
            ATTENDANCE_SHEET_URL: 'messflow_attendance_sheet_url',
            STUDENTS_SHEET_URL: 'messflow_students_sheet_url',
            RECTOR_NAME: 'messflow_rector_name',
            EMAIL: 'messflow_email',
            CITY: 'messflow_city'
        };

        // ============================================
        // ACCOUNT INFO MODAL FUNCTIONS
        // ============================================
        function openAccountInfo() {
            const hostelId = localStorage.getItem(SESSION_KEYS.HOSTEL_ID) || 'Not Available';
            const hostelName = localStorage.getItem(SESSION_KEYS.HOSTEL_NAME) || 'Hostel';
            const sheetUrl = localStorage.getItem(SESSION_KEYS.ATTENDANCE_SHEET_URL) || '';
            const studentsUrl = localStorage.getItem(SESSION_KEYS.STUDENTS_SHEET_URL) || '';
            const rectorName = localStorage.getItem(SESSION_KEYS.RECTOR_NAME) || 'Not Available';
            const email = localStorage.getItem(SESSION_KEYS.EMAIL) || 'Not Available';
            const city = localStorage.getItem(SESSION_KEYS.CITY) || 'Not Available';

            // Update modal content
            document.getElementById('accountInitial').textContent = hostelName.charAt(0).toUpperCase();
            document.getElementById('accountHostelName').textContent = hostelName;
            document.getElementById('accountHostelId').textContent = hostelId;
            document.getElementById('accountHostelNameInfo').textContent = hostelName;
            document.getElementById('accountRectorName').textContent = rectorName;
            document.getElementById('accountEmail').textContent = email;
            document.getElementById('accountCity').textContent = city;

            const sheetUrlEl = document.getElementById('accountSheetUrl');
            sheetUrlEl.textContent = sheetUrl ? 'Open Attendance Sheet â†’' : 'Not Available';
            sheetUrlEl.dataset.url = sheetUrl;

            const studentsUrlEl = document.getElementById('accountStudentsUrl');
            studentsUrlEl.textContent = studentsUrl ? 'Open Students Sheet â†’' : 'Not Available';
            studentsUrlEl.dataset.url = studentsUrl;

            // Show modal
            document.getElementById('accountInfoOverlay').style.display = 'block';
        }

        function closeAccountInfo() {
            document.getElementById('accountInfoOverlay').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all session data
                localStorage.removeItem(SESSION_KEYS.HOSTEL_ID);
                localStorage.removeItem(SESSION_KEYS.HOSTEL_NAME);
                localStorage.removeItem(SESSION_KEYS.ATTENDANCE_SHEET_URL);
                localStorage.removeItem(SESSION_KEYS.STUDENTS_SHEET_URL);

                // Clear all caches
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('hostel_') || key.startsWith('messflow_'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Redirect to welcome
                window.location.href = 'welcome.html';
            }
        }

        // Update user avatar with hostel name initial
        function updateUserAvatar() {
            const hostelName = localStorage.getItem(SESSION_KEYS.HOSTEL_NAME) || 'Attendance';
            const initial = hostelName.charAt(0).toUpperCase();

            // Update avatar in search bar
            const avatar = document.getElementById('userAvatar');
            if (avatar) avatar.textContent = initial;

            // Update drawer header
            const drawerName = document.getElementById('hostelNameDisplay');
            if (drawerName) drawerName.textContent = hostelName;
        }

        // Call on page load
        setTimeout(updateUserAvatar, 100);

        // Get attendance sheet URL (for saving attendance data)
        function getSessionSheetUrl() {
            return localStorage.getItem(SESSION_KEYS.ATTENDANCE_SHEET_URL) || null;
        }

        // Get students sheet URL (for loading student list)
        function getStudentsSheetUrl() {
            return localStorage.getItem(SESSION_KEYS.STUDENTS_SHEET_URL) || null;
        }

        // Display hostel name in drawer header
        function displayHostelName() {
            const hostelName = localStorage.getItem(SESSION_KEYS.HOSTEL_NAME);
            const displayEl = document.getElementById('hostelNameDisplay');
            if (displayEl && hostelName) {
                displayEl.textContent = hostelName;
            }
        }

        // Handle logout
        function handleLogout() {
            if (hasUnsyncedChanges) {
                if (!confirm('You have unsaved changes! Are you sure you want to logout?')) {
                    return;
                }
            }

            // Clear session (both sheet URLs)
            localStorage.removeItem(SESSION_KEYS.HOSTEL_ID);
            localStorage.removeItem(SESSION_KEYS.HOSTEL_NAME);
            localStorage.removeItem(SESSION_KEYS.ATTENDANCE_SHEET_URL);
            localStorage.removeItem(SESSION_KEYS.STUDENTS_SHEET_URL);

            // Redirect to welcome page
            window.location.replace('welcome.html');
        }

        // Initialize session on load
        function initSession() {
            displayHostelName();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function () {
            initSession(); // Initialize Multi-Hostel session
            initTheme();
            restoreLastState(); // Restore date and category from last session
            loadSyncStatus(); // Load which date+categories have been synced
            setTodayDate();
            document.getElementById('attendanceDate').addEventListener('change', handleDateChange);
            document.getElementById('studentSearch').addEventListener('input', function () {
                studentSearchQuery = (this.value || '').trim().toLowerCase();
                renderStudentList();
            });

            // Scroll effect
            window.addEventListener('scroll', () => {
                const pill = document.getElementById('searchPill');
                if (!pill) return;
                if (window.scrollY > 10) {
                    pill.classList.add('elevated');
                } else {
                    pill.classList.remove('elevated');
                }
            });

            // Save state and warn before page unload (refresh/close)
            window.addEventListener('beforeunload', function (e) {
                saveCurrentState();
                saveDraft(); // Also save draft immediately on leave

                // Warn if there are unsynced changes
                if (hasUnsyncedChanges) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved attendance changes! Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Auto-fetch students from Google Sheets on load
            // Draft will be loaded after students are fetched
            fetchStudentsFromSheet().then(() => {
                // Load any saved draft after students are available
                if (loadAttendanceDraft()) {
                    renderStudentList();
                    updateVerificationUI();
                }
            }).catch(() => {
                // Even on error, try to load draft
                loadAttendanceDraft();
            });
        });

        // --- iOS-Style Toast & Loading Functions ---
        function showIOSToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('iosToastContainer');
            if (!container) return;

            // Remove existing toast
            container.innerHTML = '';

            const icons = {
                success: 'check',
                error: 'close',
                warning: 'priority_high',
                info: 'info'
            };

            const toast = document.createElement('div');
            toast.className = `ios-toast ${type}`;
            toast.innerHTML = `
                <div class="ios-toast-icon">
                    <span class="material-symbols-outlined">${icons[type] || 'info'}</span>
                </div>
                <span>${message}</span>
            `;

            container.appendChild(toast);

            // Auto dismiss
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 250);
            }, duration);
        }

        function showIOSLoading(text = 'Processing...') {
            const overlay = document.getElementById('iosLoadingOverlay');
            const textEl = document.getElementById('iosLoadingText');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.classList.remove('hiding');
            }
            if (textEl) textEl.textContent = text;
        }

        function hideIOSLoading() {
            const overlay = document.getElementById('iosLoadingOverlay');
            if (overlay) {
                overlay.classList.add('hiding');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('hiding');
                }, 200);
            }
        }

        // --- Sync Status Management ---
        function loadSyncStatus() {
            try {
                const saved = localStorage.getItem(SYNC_STATUS_KEY);
                if (saved) {
                    syncedCategories = JSON.parse(saved);
                }
            } catch (e) { syncedCategories = {}; }
        }

        function saveSyncStatus() {
            try {
                localStorage.setItem(SYNC_STATUS_KEY, JSON.stringify(syncedCategories));
            } catch (e) { /* ignore */ }
        }

        function isSynced(date, category) {
            const key = `${date}_${category}`;
            return syncedCategories[key] === true;
        }

        function markAsSynced(date, category) {
            const key = `${date}_${category}`;
            syncedCategories[key] = true;
            saveSyncStatus();
        }

        // --- State Persistence ---
        function saveCurrentState() {
            const date = document.getElementById('attendanceDate')?.value;
            try {
                // Save current attendance for all categories
                const store = getSavedStore();
                if (date) {
                    store[date] = store[date] || {};
                    CATEGORIES.forEach(cat => {
                        if (attendanceByCategory[cat] && Object.keys(attendanceByCategory[cat]).length > 0) {
                            store[date][cat] = { ...attendanceByCategory[cat] };
                        }
                    });
                    store[date].verified = verifiedCategories;
                    setSavedStore(store);
                }

                // Save last viewed date and category
                localStorage.setItem(LAST_STATE_KEY, JSON.stringify({
                    date: date,
                    category: currentCategory
                }));
            } catch (e) { /* ignore */ }
        }

        function restoreLastState() {
            try {
                const saved = localStorage.getItem(LAST_STATE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    // Restore category if needed AND update UI
                    if (state.category && CATEGORIES.includes(state.category)) {
                        currentCategory = state.category;
                        // Update header title to match restored category
                        const headerTitle = document.getElementById('headerTitle');
                        if (headerTitle) headerTitle.textContent = state.category;

                        // Update drawer active state to match restored category
                        updateDrawerActiveState(state.category);
                    }
                }
            } catch (e) { /* ignore */ }
        }

        // Update drawer active state for a given category
        function updateDrawerActiveState(category) {
            document.querySelectorAll('.drawer-item').forEach(el => {
                el.classList.remove('active');
            });
            const navId = `nav-${category}`;
            const activeItem = document.getElementById(navId);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // --- Auto-Save Draft System ---
        const DRAFT_KEY = 'hostel_attendance_draft_v1';
        let draftSaveTimeout = null;

        // Auto-save attendance draft (debounced)
        function autoSaveAttendance() {
            // Clear any pending save
            if (draftSaveTimeout) clearTimeout(draftSaveTimeout);

            // Debounce: save after 2 seconds of no changes
            draftSaveTimeout = setTimeout(() => {
                saveDraft();
            }, 2000);

            // Also save immediately to existing state system
            saveCurrentState();
        }

        // Save draft to localStorage
        function saveDraft() {
            try {
                const date = document.getElementById('attendanceDate')?.value;
                if (!date) return;

                // Get current timestamp
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // Only save draft for today's date
                if (date !== today) return;

                // Build draft object
                const draft = {
                    date: date,
                    category: currentCategory,
                    attendanceByCategory: {},
                    verifiedCategories: { ...verifiedCategories },
                    timestamp: now.toISOString()
                };

                // Save attendance for all categories that have data
                CATEGORIES.forEach(cat => {
                    if (attendanceByCategory[cat] && Object.keys(attendanceByCategory[cat]).length > 0) {
                        draft.attendanceByCategory[cat] = { ...attendanceByCategory[cat] };
                    }
                });

                // Only save if there's actual data
                if (Object.keys(draft.attendanceByCategory).length > 0) {
                    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
                }
            } catch (e) {
                console.error('Draft save failed:', e);
            }
        }

        // Load draft on app start (only for today's date)
        function loadAttendanceDraft() {
            try {
                const saved = localStorage.getItem(DRAFT_KEY);
                if (!saved) return false;

                const draft = JSON.parse(saved);
                if (!draft || !draft.date) return false;

                // Get today's date
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // ONLY restore if draft is for TODAY
                if (draft.date !== today) {
                    // Old draft - clear it
                    localStorage.removeItem(DRAFT_KEY);
                    return false;
                }

                // Check if there's actual data to restore
                if (!draft.attendanceByCategory || Object.keys(draft.attendanceByCategory).length === 0) {
                    return false;
                }

                // Count how many records are being restored
                let totalRestored = 0;

                // Restore attendance by category
                CATEGORIES.forEach(cat => {
                    if (draft.attendanceByCategory[cat]) {
                        ensureCategoryAttendance(cat);
                        Object.assign(attendanceByCategory[cat], draft.attendanceByCategory[cat]);
                        totalRestored += Object.keys(draft.attendanceByCategory[cat]).length;
                    }
                });

                // Restore verified categories
                if (draft.verifiedCategories) {
                    Object.assign(verifiedCategories, draft.verifiedCategories);
                }

                // Set current attendance
                if (attendanceByCategory[currentCategory]) {
                    attendance = attendanceByCategory[currentCategory];
                }

                // Mark that we have unsaved changes (draft was restored)
                if (totalRestored > 0) {
                    hasUnsyncedChanges = true;

                    // Show iOS toast notification
                    setTimeout(() => {
                        showIOSToast('ðŸ“‹ Draft restored from earlier session', 'info', 4000);
                    }, 1500);

                    return true;
                }

                return false;
            } catch (e) {
                console.error('Draft load failed:', e);
                return false;
            }
        }

        // Clear draft after successful sync
        function clearAttendanceDraft() {
            try {
                localStorage.removeItem(DRAFT_KEY);
                hasUnsyncedChanges = false;
            } catch (e) { /* ignore */ }
        }

        // ============================================
        // MULTI-DEVICE SYNC SYSTEM
        // Check if attendance already submitted from another device
        // ============================================

        let currentSyncStatus = null; // Track current sync status

        // Check server for attendance status
        async function checkServerSyncStatus(date, category) {
            if (!date || !category) return null;

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'check_attendance_status',
                        date: date,
                        category: category,
                        totalStudents: students.length || 45,
                        sheetUrl: getSessionSheetUrl()
                    })
                });

                if (!response.ok) {
                    console.error('Sync status check failed');
                    return null;
                }

                const result = await response.json();
                if (result.result === 'success') {
                    currentSyncStatus = result;
                    return result;
                }

                return null;
            } catch (e) {
                console.error('Sync status check error:', e);
                return null;
            }
        }

        // Show sync status banner
        function showSyncBanner(status, message, type = 'submitted') {
            const banner = document.getElementById('syncStatusBanner');
            const textEl = document.getElementById('syncBannerText');
            const iconEl = banner.querySelector('.sync-banner-icon');

            if (!banner) return;

            // Set message
            textEl.textContent = message;

            // Set type/color
            banner.classList.remove('warning', 'info');
            if (type === 'warning') {
                banner.classList.add('warning');
                iconEl.textContent = 'warning';
            } else if (type === 'info') {
                banner.classList.add('info');
                iconEl.textContent = 'cloud_sync';
            } else {
                iconEl.textContent = 'cloud_done';
            }

            // Show banner
            banner.style.display = 'flex';

            // If submitted, apply read-only state
            if (status === 'submitted') {
                document.body.classList.add('attendance-readonly');
            }
        }

        // Dismiss sync banner
        function dismissSyncBanner() {
            const banner = document.getElementById('syncStatusBanner');
            if (banner) {
                banner.style.display = 'none';
            }
            // Note: Don't remove attendance-readonly here - status is still submitted
        }

        // Apply server attendance data (when submitted from another device)
        function applyServerAttendance(serverData, category) {
            if (!serverData || !category) return;

            ensureCategoryAttendance(category);

            // Clear existing data for this category
            attendanceByCategory[category] = {};

            // Apply server data
            Object.keys(serverData).forEach(name => {
                attendanceByCategory[category][name] = serverData[name];
            });

            // Update current view
            if (currentCategory === category) {
                attendance = attendanceByCategory[category];
            }

            // Clear local draft for this category (server is source of truth)
            clearAttendanceDraft();

            // Re-render
            renderStudentList();
            updateStats();
        }

        // Handle sync status response
        async function handleSyncStatusCheck() {
            const date = document.getElementById('attendanceDate')?.value;
            if (!date || !currentCategory) return;

            const status = await checkServerSyncStatus(date, currentCategory);

            if (!status) return; // API failed, continue normally

            // Hide any existing banner first
            const banner = document.getElementById('syncStatusBanner');
            if (banner) banner.style.display = 'none';
            document.body.classList.remove('attendance-readonly');

            if (status.status === 'submitted') {
                // Attendance already submitted!
                showSyncBanner('submitted',
                    `âœ“ ${currentCategory} attendance already submitted (${status.recordCount}/${status.totalStudents} students)`,
                    'submitted'
                );

                // Load server data
                if (status.attendanceData) {
                    applyServerAttendance(status.attendanceData, currentCategory);
                }

                // Mark as synced
                markAsSynced(date, currentCategory);

            } else if (status.status === 'in_progress') {
                // Partial data exists
                showSyncBanner('in_progress',
                    `âš  ${currentCategory}: ${status.recordCount} students already marked on another device`,
                    'warning'
                );
            }
            // 'not_started' = no banner, normal flow
        }

        // --- Theme Logic ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
            closeDrawer();
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (!icon || !text) return;
            if (theme === 'dark') {
                icon.textContent = 'light_mode';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'dark_mode';
                text.textContent = 'Dark Mode';
            }
        }

        // --- Drawer Logic ---
        let scrollPosition = 0;

        function openDrawer() {
            const d = document.getElementById('navDrawer');
            const s = document.getElementById('drawerScrim');
            // Save scroll position and lock body
            scrollPosition = window.pageYOffset;
            document.body.style.top = `-${scrollPosition}px`;
            document.body.classList.add('drawer-open');
            if (d) d.classList.add('open');
            if (s) s.classList.add('open');
        }

        function closeDrawer() {
            const d = document.getElementById('navDrawer');
            const s = document.getElementById('drawerScrim');
            if (d) d.classList.remove('open');
            if (s) s.classList.remove('open');
            // Restore scroll position
            document.body.classList.remove('drawer-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        // --- Swipe Gesture to Open/Close Drawer ---
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let isSwiping = false;

        document.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = true;
        }, { passive: true });

        document.addEventListener('touchend', function (e) {
            if (!isSwiping) return;
            touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipeGesture(touchStartX, touchEndX, touchStartY, touchEndY);
            isSwiping = false;
        }, { passive: true });

        function handleSwipeGesture(startX, endX, startY, endY) {
            const diffX = endX - startX;
            const diffY = Math.abs(endY - startY);
            const minSwipeDistance = 80; // Minimum swipe distance

            // Only trigger if horizontal swipe is greater than vertical (not scrolling)
            if (Math.abs(diffX) > diffY && Math.abs(diffX) > minSwipeDistance) {
                const drawer = document.getElementById('navDrawer');
                const isDrawerOpen = drawer && drawer.classList.contains('open');

                // Swipe right to open (from left half of screen)
                if (diffX > 0 && startX < window.innerWidth / 2 && !isDrawerOpen) {
                    openDrawer();
                }
                // Swipe left to close
                else if (diffX < 0 && isDrawerOpen) {
                    closeDrawer();
                }
            }
        }

        // --- Core Logic ---
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const dateEl = document.getElementById('attendanceDate');
            if (dateEl) dateEl.value = dateStr;
            const hDate = document.getElementById('headerDate');
            if (hDate) hDate.textContent = new Date(dateStr).toDateString();
        }

        function handleDateChange() {
            const dateStr = document.getElementById('attendanceDate').value;
            if (!dateStr) return;

            const hDate = document.getElementById('headerDate');
            if (hDate) hDate.textContent = new Date(dateStr).toDateString();

            loadedFromSheets[dateStr] = loadedFromSheets[dateStr] || {};

            if (students.length > 0) {
                initializeAllCategoriesAttendance();
                applySavedAttendanceForDate(dateStr);
                loadVerificationState(dateStr);
                ensureCategoryAttendance(currentCategory);
                attendance = attendanceByCategory[currentCategory];
                loadAttendanceData().then(() => {
                    updateVerificationUI();
                    updateFetchButtonVisibility();
                });
            } else {
                renderStudentList();
                loadVerificationState(dateStr);
                updateFetchButtonVisibility();
            }

            // Multi-device sync: Check if this date is already submitted
            handleSyncStatusCheck();
        }

        function switchCategory(newCategory) {
            currentCategory = newCategory;

            // Update Title
            const t = document.getElementById('headerTitle');
            if (t) t.textContent = newCategory;

            // Update Drawer Active State
            document.querySelectorAll('.drawer-item').forEach(el => {
                el.classList.remove('active');
                if (el.textContent.includes(newCategory) && !el.textContent.includes('Download') && !el.textContent.includes('Reset') && !el.textContent.includes('Mode')) {
                    el.classList.add('active');
                }
            });
            // Specific ID fallback
            const navId = `nav-${newCategory}`;
            const activeItem = document.getElementById(navId);
            if (activeItem) activeItem.classList.add('active');

            closeDrawer();

            ensureCategoryAttendance(currentCategory);
            attendance = attendanceByCategory[currentCategory];

            const date = document.getElementById('attendanceDate').value;
            if (date && students.length > 0) {
                loadedFromSheets[date] = loadedFromSheets[date] || {};
                if (!loadedFromSheets[date][currentCategory]) {
                    loadAttendanceData();
                }
            }

            renderStudentList();
            updateVerificationUI();
            updateFetchButtonVisibility();

            // Multi-device sync: Check if this section is already submitted
            handleSyncStatusCheck();
        }

        // --- Fetch Button Logic ---
        function updateFetchButtonVisibility() {
            const container = document.getElementById('fetchButtonContainer');
            const categoryLabel = document.getElementById('fetchCategoryName');
            const statusText = document.getElementById('fetchStatusText');
            if (!container) return;

            const date = document.getElementById('attendanceDate').value;
            // Use local date format (YYYY-MM-DD) instead of UTC to avoid timezone issues
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Show fetch button only for past dates
            if (date < today) {
                container.style.display = 'block';
                if (categoryLabel) categoryLabel.textContent = currentCategory;

                // Update status text
                if (statusText) {
                    if (isSynced(date, currentCategory)) {
                        statusText.textContent = 'âœ“ Data already loaded from database';
                        statusText.style.color = 'var(--color-present)';
                    } else {
                        statusText.textContent = 'Click to fetch attendance records from database';
                        statusText.style.color = 'var(--md-sys-color-on-surface-variant)';
                    }
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Fetch current section's data from database
        async function fetchCurrentSectionFromDB() {
            const date = document.getElementById('attendanceDate').value;
            const category = currentCategory;

            if (!date) {
                showMessage('Please select a date', 'error');
                return;
            }

            showIOSLoading(`Fetching ${category} data...`);

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "fetch_category_data",
                        date: date,
                        category: category,
                        sheetUrl: getSessionSheetUrl()
                    })
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success' && json.data && json.data.length > 1) {
                    // Parse and populate attendance
                    const rows = json.data;
                    const headers = rows[0];
                    const nameIdx = headers.indexOf('Full Name');
                    const statusIdx = headers.indexOf('Status');

                    if (nameIdx !== -1 && statusIdx !== -1) {
                        ensureCategoryAttendance(category);
                        let count = 0;
                        for (let i = 1; i < rows.length; i++) {
                            const name = rows[i][nameIdx];
                            const status = rows[i][statusIdx];
                            if (name && ['Present', 'Absent', 'Leave'].includes(status)) {
                                attendanceByCategory[category][name] = status;
                                count++;
                            }
                        }

                        if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                        loadedFromSheets[date][category] = true;
                        markAsSynced(date, category);

                        attendance = attendanceByCategory[currentCategory];
                        renderStudentList();
                        updateFetchButtonVisibility();
                        showMessage(`Fetched ${count} records for ${category}!`, 'success');
                    } else {
                        showMessage('Invalid data format from database', 'error');
                    }
                } else if (json.result === 'success') {
                    showMessage(`No ${category} data found for ${date}`, 'warning');
                } else {
                    showMessage(`Fetch Failed: ${json.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        // --- Sync Tracker Logic (YouTube-Level Optimized) ---
        let trackerDaysRange = 7;

        // SyncCache with TTL for production-level caching
        const SyncCache = {
            data: {},
            ttl: 5 * 60 * 1000, // 5 minutes cache

            getKey(date, category) {
                return `${date}_${category}`;
            },

            get(date, category) {
                const key = this.getKey(date, category);
                const entry = this.data[key];
                if (!entry) return null;
                if (Date.now() - entry.timestamp > this.ttl) {
                    delete this.data[key];
                    return null;
                }
                return entry.value;
            },

            set(date, category, count) {
                const key = this.getKey(date, category);
                this.data[key] = {
                    value: count,
                    timestamp: Date.now()
                };
            },

            setBatch(statusData) {
                Object.keys(statusData).forEach(date => {
                    Object.keys(statusData[date]).forEach(category => {
                        this.set(date, category, statusData[date][category]);
                    });
                });
            },

            clear() {
                this.data = {};
            }
        };

        // Batch fetch sync status from database
        async function fetchSyncStatusFromDB(dates) {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_sync_status',
                        dates: dates,
                        totalStudents: students.length,
                        sheetUrl: getSessionSheetUrl()
                    })
                });
                const json = await res.json();
                if (json.result === 'success') {
                    SyncCache.setBatch(json.data);
                    return json.data;
                }
            } catch (e) {
                console.error('Sync status fetch error:', e);
            }
            return null;
        }

        // Check if synced from cache or return null
        function getCachedSyncCount(date, category) {
            return SyncCache.get(date, category);
        }

        function openSyncTracker() {
            closeDrawer();
            const modal = document.getElementById('syncTrackerModal');
            if (modal) {
                modal.style.display = 'block';
                // Use setTimeout to trigger CSS transition
                setTimeout(() => {
                    modal.classList.add('open');
                }, 10);
                renderSyncTrackerGrid();
            }
        }

        function closeSyncTracker() {
            const modal = document.getElementById('syncTrackerModal');
            if (modal) {
                modal.classList.remove('open');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 350); // Match transition duration
            }
        }

        function setTrackerRange(days) {
            trackerDaysRange = days;
            // Update active pill
            document.querySelectorAll('.date-range-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.textContent.includes(days)) {
                    pill.classList.add('active');
                }
            });
            // Hide custom date picker when preset is selected
            const customPicker = document.getElementById('customDatePicker');
            if (customPicker) customPicker.style.display = 'none';

            renderSyncTrackerGrid();
        }

        function showCustomDatePicker() {
            // Update active pill
            document.querySelectorAll('.date-range-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.textContent === 'Custom') {
                    pill.classList.add('active');
                }
            });

            // Show custom date picker
            const customPicker = document.getElementById('customDatePicker');
            if (customPicker) {
                customPicker.style.display = 'block';

                // Set default dates (last 7 days)
                const now = new Date();
                const endDate = now.toISOString().split('T')[0];
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 7);

                document.getElementById('trackerEndDate').value = endDate;
                document.getElementById('trackerStartDate').value = startDate.toISOString().split('T')[0];
            }
        }

        function applyCustomDateRange() {
            const startDateInput = document.getElementById('trackerStartDate');
            const endDateInput = document.getElementById('trackerEndDate');

            if (!startDateInput.value || !endDateInput.value) {
                showMessage('Please select both dates', 'error');
                return;
            }

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate > endDate) {
                showMessage('Start date must be before end date', 'error');
                return;
            }

            // Calculate days between dates
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            trackerDaysRange = diffDays;
            customStartDate = startDateInput.value;
            customEndDate = endDateInput.value;
            isCustomRange = true;

            renderSyncTrackerGridCustom(startDate, endDate);
        }

        let customStartDate = null;
        let customEndDate = null;
        let isCustomRange = false;

        async function renderSyncTrackerGrid() {
            const tbody = document.getElementById('syncTrackerBody');
            if (!tbody) return;

            // Show loading state
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--md-sys-color-on-surface-variant);">Loading from database...</td></tr>';

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Build dates array for batch fetch
            const dates = [];
            for (let i = 0; i < trackerDaysRange; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                dates.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
            }

            // Batch fetch from database
            const dbStatus = await fetchSyncStatusFromDB(dates);
            const totalStudents = students.length;

            let html = '';
            let totalDays = 0;
            let completeDays = 0;

            for (let i = 0; i < trackerDaysRange; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dateStr = dates[i];
                const displayDate = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });

                const isToday = dateStr === todayStr;

                // Get counts from database
                const yogaCount = dbStatus?.[dateStr]?.['Yoga'] || 0;
                const messDayCount = dbStatus?.[dateStr]?.['Mess Day'] || 0;
                const messNightCount = dbStatus?.[dateStr]?.['Mess Night'] || 0;
                const nightShiftCount = dbStatus?.[dateStr]?.['Night Shift'] || 0;

                // Calculate sync status: full, partial, or none
                const yogaStatus = getSyncLevel(yogaCount, totalStudents);
                const messDayStatus = getSyncLevel(messDayCount, totalStudents);
                const messNightStatus = getSyncLevel(messNightCount, totalStudents);
                const nightShiftStatus = getSyncLevel(nightShiftCount, totalStudents);
                const allSynced = yogaStatus === 'full' && messDayStatus === 'full' && messNightStatus === 'full' && nightShiftStatus === 'full';

                // Count for summary (exclude today)
                if (!isToday) {
                    totalDays++;
                    if (allSynced) completeDays++;
                }

                html += `
                    <tr class="${isToday ? 'today' : ''}">
                        <td>${displayDate}${isToday ? ' <span style="font-size:10px;color:var(--md-sys-color-primary);">(Today)</span>' : ''}</td>
                        <td>${renderStatusDotDB(yogaStatus, yogaCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messDayStatus, messDayCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messNightStatus, messNightCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(nightShiftStatus, nightShiftCount, totalStudents, isToday)}</td>
                        <td>${allSynced ? '<span class="status-dot complete"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>' : '<span class="status-dot not-synced">â—‹</span>'}</td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;

            // Update summary
            const percentage = totalDays > 0 ? Math.round((completeDays / totalDays) * 100) : 0;
            const progressFill = document.getElementById('syncProgressFill');
            const summaryStats = document.getElementById('syncSummaryStats');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (summaryStats) summaryStats.innerHTML = `<strong>${percentage}%</strong> Complete â€¢ <strong>${completeDays}/${totalDays}</strong> Days Fully Synced`;
        }

        // Get sync level: 'full' or 'none'
        // Note: If data exists, it's 'full' - we can't compare against current student count
        // because new students may have been added after historical dates were synced
        function getSyncLevel(count, total) {
            // If there's any data synced, mark as full (can't retroactively add new students)
            if (count > 0) return 'full';
            return 'none';
        }

        // Render status dot based on database count
        function renderStatusDotDB(status, count, total, isToday) {
            if (status === 'full') {
                return '<span class="status-dot synced"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>';
            } else if (status === 'partial') {
                return `<span class="status-dot" style="background:rgba(255,149,0,0.15);color:#FF9500;" title="${count}/${total}"><span class="material-symbols-outlined" style="font-size:16px;">remove</span></span>`;
            } else if (isToday) {
                return '<span class="status-dot not-synced" style="background:rgba(0,122,255,0.1);color:#007AFF;">â—‹</span>';
            } else {
                return '<span class="status-dot not-synced">â—‹</span>';
            }
        }

        function renderStatusDot(isSynced, isToday) {
            if (isSynced) {
                return '<span class="status-dot synced"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>';
            } else if (isToday) {
                return '<span class="status-dot not-synced" style="background:rgba(0,122,255,0.1);color:#007AFF;">â—‹</span>';
            } else {
                return '<span class="status-dot not-synced">â—‹</span>';
            }
        }

        // Render grid for custom date range - NOW FETCHES FROM DATABASE!
        async function renderSyncTrackerGridCustom(startDate, endDate) {
            const tbody = document.getElementById('syncTrackerBody');
            if (!tbody) return;

            // Show loading state
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--md-sys-color-on-surface-variant);">Loading from database...</td></tr>';

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Build dates array for the custom range
            const dates = [];
            const current = new Date(endDate);
            while (current >= startDate) {
                const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                dates.push(dateStr);
                current.setDate(current.getDate() - 1);
            }

            // Batch fetch from database (like preset ranges)
            const dbStatus = await fetchSyncStatusFromDB(dates);
            const totalStudents = students.length;

            let html = '';
            let totalDays = 0;
            let completeDays = 0;

            // Iterate through dates (already in order)
            for (const dateStr of dates) {
                const d = new Date(dateStr + 'T00:00:00');
                const displayDate = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                const isToday = dateStr === todayStr;

                // Get counts from database
                const yogaCount = dbStatus?.[dateStr]?.['Yoga'] || 0;
                const messDayCount = dbStatus?.[dateStr]?.['Mess Day'] || 0;
                const messNightCount = dbStatus?.[dateStr]?.['Mess Night'] || 0;
                const nightShiftCount = dbStatus?.[dateStr]?.['Night Shift'] || 0;

                // Calculate sync status: full, partial, or none
                const yogaStatus = getSyncLevel(yogaCount, totalStudents);
                const messDayStatus = getSyncLevel(messDayCount, totalStudents);
                const messNightStatus = getSyncLevel(messNightCount, totalStudents);
                const nightShiftStatus = getSyncLevel(nightShiftCount, totalStudents);
                const allSynced = yogaStatus === 'full' && messDayStatus === 'full' && messNightStatus === 'full' && nightShiftStatus === 'full';

                // Count for summary (exclude today)
                if (!isToday) {
                    totalDays++;
                    if (allSynced) completeDays++;
                }

                html += `
                    <tr class="${isToday ? 'today' : ''}">
                        <td>${displayDate}${isToday ? ' <span style="font-size:10px;color:var(--md-sys-color-primary);">(Today)</span>' : ''}</td>
                        <td>${renderStatusDotDB(yogaStatus, yogaCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messDayStatus, messDayCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messNightStatus, messNightCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(nightShiftStatus, nightShiftCount, totalStudents, isToday)}</td>
                        <td>${allSynced ? '<span class="status-dot complete"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>' : '<span class="status-dot not-synced">â—‹</span>'}</td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;

            // Update summary
            const percentage = totalDays > 0 ? Math.round((completeDays / totalDays) * 100) : 0;
            const progressFill = document.getElementById('syncProgressFill');
            const summaryStats = document.getElementById('syncSummaryStats');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (summaryStats) summaryStats.innerHTML = `<strong>${percentage}%</strong> Complete â€¢ <strong>${completeDays}/${totalDays}</strong> Days Fully Synced`;

            showMessage('Custom range applied!', 'success');
        }

        // --- Fetch Students from Google Sheets (with caching) ---
        // Cache key is unique per hostel to prevent loading wrong students
        function getStudentsCacheKey() {
            const hostelId = localStorage.getItem(SESSION_KEYS.HOSTEL_ID) || 'default';
            return 'hostel_students_cache_' + hostelId;
        }

        async function fetchStudentsFromSheet() {
            // 1. First, try to load from cache for instant display
            const cached = loadStudentsFromCache();
            if (cached && cached.length > 0) {
                students = cached;
                initializeAllCategoriesAttendance();
                attendance = attendanceByCategory[currentCategory];
                renderStudentList();
                showMessage('Loading updates...', 'info');
            } else {
                showMessage('Loading students...', 'info');
            }

            // 2. Then fetch fresh data from server in background
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_students',
                        studentsSheetUrl: getStudentsSheetUrl() // Use Rector's students sheet
                    })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    const freshStudents = (json.students || []).map(s => ({
                        name: s.name,
                        appNumber: s.appNumber || '',
                        appId: s.appId || s.appNumber || 'N/A',
                        hostelId: s.hostelId || '',
                        allocation: s.allocation || ''
                    }));

                    // Save to cache for next time
                    saveStudentsToCache(freshStudents);

                    // Update only if data changed
                    if (JSON.stringify(freshStudents) !== JSON.stringify(students)) {
                        students = freshStudents;
                        if (students.length > 0) {
                            initializeAllCategoriesAttendance();
                            attendance = attendanceByCategory[currentCategory];
                            handleDateChange();
                        } else {
                            renderStudentList();
                        }
                    }

                    if (students.length > 0) {
                        showMessage(`âœ“ ${students.length} students ready`, 'success');
                    } else {
                        showMessage('No students found. Add students to get started.', 'info');
                    }
                } else {
                    if (!cached || cached.length === 0) {
                        showMessage(`Error: ${json.error}`, 'error');
                        renderStudentList();
                    }
                }
            } catch (e) {
                if (!cached || cached.length === 0) {
                    showMessage(`Network Error: ${e.message}`, 'error');
                    renderStudentList();
                } else {
                    showMessage('Using cached data (offline)', 'info');
                }
            }
        }

        function saveStudentsToCache(studentsList) {
            try {
                localStorage.setItem(getStudentsCacheKey(), JSON.stringify({
                    timestamp: Date.now(),
                    students: studentsList
                }));
            } catch (e) { /* ignore storage errors */ }
        }

        function loadStudentsFromCache() {
            try {
                const cached = localStorage.getItem(getStudentsCacheKey());
                if (cached) {
                    const data = JSON.parse(cached);
                    // Cache valid for 24 hours
                    if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
                        return data.students || [];
                    }
                }
            } catch (e) { /* ignore parse errors */ }
            return null;
        }

        // --- Add Student Modal Functions ---
        function openAddStudentModal() {
            closeDrawer();
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.style.display = 'flex';
                // Clear previous values
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentAppNumber').value = '';
                document.getElementById('newStudentAppId').value = '';
                document.getElementById('newStudentHostelId').value = '';
                document.getElementById('newStudentAllocation').value = '';
                document.getElementById('addStudentError').style.display = 'none';
            }
        }

        function closeAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            if (modal) modal.style.display = 'none';
        }

        async function saveNewStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            const appNumber = document.getElementById('newStudentAppNumber').value.trim();
            const appId = document.getElementById('newStudentAppId').value.trim();
            const hostelId = document.getElementById('newStudentHostelId').value.trim();
            const allocation = document.getElementById('newStudentAllocation').value.trim();
            const errorDiv = document.getElementById('addStudentError');

            if (!name) {
                errorDiv.textContent = 'Student name is required';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            showMessage('Adding student...', 'info');

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add_student',
                        student: { name, appNumber, appId, hostelId, allocation },
                        sheetUrl: getSessionSheetUrl()
                    })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    closeAddStudentModal();
                    // Add to local cache immediately for faster next load with full data
                    const newStudent = {
                        name,
                        appNumber: appNumber || '',
                        appId: appId || appNumber || 'N/A',
                        hostelId: hostelId || '',
                        allocation: allocation || ''
                    };
                    students.push(newStudent);
                    saveStudentsToCache(students);
                    initializeAllCategoriesAttendance();
                    attendance = attendanceByCategory[currentCategory];
                    renderStudentList();
                    showMessage('âœ“ Student added successfully!', 'success');
                } else {
                    errorDiv.textContent = json.error || 'Failed to add student';
                    errorDiv.style.display = 'block';
                }
            } catch (e) {
                errorDiv.textContent = `Network Error: ${e.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // --- Rendering ---
        function renderStudentList() {
            const listDiv = document.getElementById('studentList');
            listDiv.innerHTML = '';

            const countEl = document.getElementById('totalStudentsCount');
            if (countEl) countEl.textContent = `${students.length} total`;

            if (students.length === 0) {
                listDiv.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--md-sys-color-outline);">
                <span class="material-symbols-outlined" style="font-size: 48px; display:block; margin-bottom:16px;">group</span>
                No students found.<br>Use "Add Student" from the menu to add students.
            </div>`;
                updateStats();
                return;
            }

            ensureCategoryAttendance(currentCategory);
            attendance = attendanceByCategory[currentCategory];

            const q = (studentSearchQuery || '').trim().toLowerCase();
            const filteredStudents = !q ? students : students.filter(s => {
                return (s.name || '').toLowerCase().includes(q) || (s.appId || '').toLowerCase().includes(q);
            });

            filteredStudents.forEach(student => {
                const status = attendance[student.name] || 'Present';
                const item = document.createElement('div');
                item.className = 'student-card';

                // Avatar Color
                const firstChar = student.name.charAt(0).toUpperCase();
                const colors = ['#007AFF', '#5856D6', '#AF52DE', '#FF2D55', '#FF9500', '#FFCC00', '#34C759', '#00C7BE', '#30B0C7', '#5AC8FA'];
                let colorIndex = 0;
                if (student.name.length > 0) {
                    colorIndex = (student.name.charCodeAt(0) + student.name.charCodeAt(Math.min(1, student.name.length - 1))) % colors.length;
                }
                const avatarColor = colors[colorIndex];

                // Single status icon based on current status
                let statusIcon, statusColor, statusBg;
                if (status === 'Present') {
                    statusIcon = 'check_circle';
                    statusColor = '#34C759';
                    statusBg = '#E3F9E8';
                } else if (status === 'Absent') {
                    statusIcon = 'cancel';
                    statusColor = '#FF3B30';
                    statusBg = '#FFE5E3';
                } else {
                    statusIcon = 'schedule';
                    statusColor = '#FF9500';
                    statusBg = '#FFF4E5';
                }

                item.innerHTML = `
                <div class="student-avatar" style="background-color: ${avatarColor}; color: white;">${firstChar}</div>
                <div class="student-info">
                    <div class="student-name">${student.name}</div>
                    <div class="student-id">${student.appId}</div>
                </div>
                <button class="status-icon-btn" onclick="cycleStatus('${student.name}')" 
                    style="width: 44px; height: 44px; border-radius: 22px; border: none; 
                    background: ${statusBg}; display: flex; align-items: center; justify-content: center; 
                    cursor: pointer; transition: transform 0.15s ease;">
                    <span class="material-symbols-outlined" style="font-size: 28px; color: ${statusColor}; font-variation-settings: 'FILL' 1;">${statusIcon}</span>
                </button>
            `;
                listDiv.appendChild(item);
            });

            updateStats();
        }

        // Cycle through Present â†’ Absent â†’ Leave â†’ Present
        function cycleStatus(studentName) {
            const date = document.getElementById('attendanceDate').value;

            // RESTRICTION: Only allow changes for TODAY's date
            const now = new Date();
            const today = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0');

            if (date !== today) {
                showMessage('âŒ Past dates are read-only!', 'warning');
                return;
            }

            // Don't allow changes if this category is already synced
            if (isSynced(date, currentCategory)) {
                showMessage(`${currentCategory} is synced. Cannot modify.`, 'warning');
                return;
            }

            ensureCategoryAttendance(currentCategory);
            const currentStatus = attendanceByCategory[currentCategory][studentName] || 'Present';
            let newStatus;
            if (currentStatus === 'Present') newStatus = 'Absent';
            else if (currentStatus === 'Absent') newStatus = 'Leave';
            else newStatus = 'Present';

            attendanceByCategory[currentCategory][studentName] = newStatus;
            attendance = attendanceByCategory[currentCategory];
            hasUnsyncedChanges = true; // Mark that we have unsaved changes
            renderStudentList();

            // Auto-save after status change
            autoSaveAttendance();
        }

        function updateStatus(studentName, status) {
            ensureCategoryAttendance(currentCategory);
            attendanceByCategory[currentCategory][studentName] = status;
            attendance = attendanceByCategory[currentCategory];
            renderStudentList();
        }

        function updateStats() {
            let p = 0, a = 0, l = 0;
            Object.values(attendance).forEach(s => {
                if (s === 'Present') p++;
                else if (s === 'Absent') a++;
                else if (s === 'Leave') l++;
            });
            const pEl = document.getElementById('presentCount'); if (pEl) pEl.textContent = p;
            const aEl = document.getElementById('absentCount'); if (aEl) aEl.textContent = a;
            const lEl = document.getElementById('leaveCount'); if (lEl) lEl.textContent = l;
        }

        // Mark All Students as Present
        function markAllPresent() {
            if (students.length === 0) {
                showIOSToast('No students to mark', 'warning');
                return;
            }
            ensureCategoryAttendance(currentCategory);
            students.forEach(student => {
                attendanceByCategory[currentCategory][student.name] = 'Present';
            });
            attendance = attendanceByCategory[currentCategory];
            renderStudentList();
            updateStats();
            showIOSToast(`All ${students.length} students marked present`, 'success');
        }

        // --- Verification Logic ---
        function toggleVerification() {
            if (!verifiedCategories) verifiedCategories = {};
            const wasVerified = verifiedCategories[currentCategory];
            verifiedCategories[currentCategory] = !verifiedCategories[currentCategory];
            updateVerificationUI(true, wasVerified);
            saveVerificationState();
        }

        function updateVerificationUI(showToast = false, wasVerified = null) {
            const card = document.getElementById('verificationCard');
            const toggle = document.getElementById('verifyToggle');
            const text = document.getElementById('verifyText');

            if (!card) return;

            const isVerified = verifiedCategories[currentCategory];

            if (isVerified) {
                card.classList.add('verified');
                toggle?.classList.add('on');
                text.textContent = `${currentCategory} Verified`;
            } else {
                card.classList.remove('verified');
                toggle?.classList.remove('on');
                text.textContent = `Mark ${currentCategory} as Verified`;
            }

            // Show iOS toast notification when toggling
            if (showToast && wasVerified !== null) {
                if (isVerified) {
                    showIOSToast('Marked as Verified', 'success');
                } else {
                    showIOSToast('Verification Removed', 'info');
                }
            }

            // Update Nav Indicators - iOS style checkmarks
            CATEGORIES.forEach(c => {
                const ind = document.getElementById(`nav-indicator-${c}`);
                if (ind) {
                    ind.textContent = verifiedCategories[c] ? 'âœ“' : '';
                    ind.style.color = verifiedCategories[c] ? 'var(--color-present, #34C759)' : '';
                    ind.style.fontWeight = verifiedCategories[c] ? '600' : '';
                }
            });
        }

        function saveVerificationState() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) return;
            const store = getSavedStore();
            store[date] = store[date] || {};
            store[date].verified = verifiedCategories;
            setSavedStore(store);
        }

        function loadVerificationState(date) {
            const store = getSavedStore();
            verifiedCategories = (store[date] && store[date].verified) || {};
            CATEGORIES.forEach(c => {
                if (typeof verifiedCategories[c] === 'undefined') verifiedCategories[c] = false;
            });
            updateVerificationUI();
        }

        // --- Persistence & Helpers ---
        function safeParseJSON(s) { try { return JSON.parse(s); } catch (e) { return null; } }
        function getSavedStore() {
            const raw = localStorage.getItem(STORAGE_KEY);
            const parsed = safeParseJSON(raw);
            return parsed && typeof parsed === 'object' ? parsed : {};
        }
        function setSavedStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

        function initializeAllCategoriesAttendance() {
            attendanceByCategory = {};
            loadedFromSheets = {};
            CATEGORIES.forEach(c => {
                attendanceByCategory[c] = {};
                students.forEach(s => attendanceByCategory[c][s.name] = 'Present');
            });
        }

        function ensureCategoryAttendance(cat) {
            if (!attendanceByCategory[cat]) attendanceByCategory[cat] = {};
            students.forEach(s => {
                if (!attendanceByCategory[cat][s.name]) attendanceByCategory[cat][s.name] = 'Present';
            });
        }

        function applySavedAttendanceForDate(date) {
            CATEGORIES.forEach(c => {
                const store = getSavedStore();
                const saved = store?.[date]?.[c];
                if (saved && typeof saved === 'object') {
                    ensureCategoryAttendance(c);
                    students.forEach(s => {
                        const v = saved[s.name];
                        if (['Present', 'Absent', 'Leave'].includes(v)) attendanceByCategory[c][s.name] = v;
                    });
                    if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                    loadedFromSheets[date][c] = true;
                }
            });
        }

        // --- CSV Parsing ---
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || '';
                }
                rows.push(row);
            }
            return rows;
        }

        function csvEscape(v) {
            v = String(v || '');
            if (/[\n\r",]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
            return v;
        }

        // --- Actions: Save, Download, Sync ---
        function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to save', 'error');
            try {
                ensureCategoryAttendance(currentCategory);
                const store = getSavedStore();
                store[date] = store[date] || {};
                store[date][currentCategory] = { ...attendanceByCategory[currentCategory] };
                store[date].verified = verifiedCategories;
                setSavedStore(store);
                showMessage(`Saved ${currentCategory} for ${date}`, 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Save ALL categories for current date
        function saveAllAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to save', 'error');
            try {
                const store = getSavedStore();
                store[date] = store[date] || {};
                CATEGORIES.forEach(cat => {
                    ensureCategoryAttendance(cat);
                    if (attendanceByCategory[cat] && Object.keys(attendanceByCategory[cat]).length > 0) {
                        store[date][cat] = { ...attendanceByCategory[cat] };
                    }
                });
                store[date].verified = verifiedCategories;
                setSavedStore(store);
                showMessage(`Saved all sections for ${date}`, 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Auto-save with debounce (called on status change)
        function autoSaveAttendance() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const date = document.getElementById('attendanceDate').value;
                if (!date || !students.length) return;
                try {
                    const store = getSavedStore();
                    store[date] = store[date] || {};
                    store[date][currentCategory] = { ...attendanceByCategory[currentCategory] };
                    store[date].verified = verifiedCategories;
                    setSavedStore(store);
                } catch (e) { /* silent auto-save */ }
            }, 500);
        }

        async function loadAttendanceData() {
            const date = document.getElementById('attendanceDate').value;
            loadedFromSheets[date] = loadedFromSheets[date] || {};
            if (loadedFromSheets[date][currentCategory]) return renderStudentList();

            if (typeof GOOGLE_SCRIPT_URL === 'undefined') return renderStudentList();

            // Try to fetch from database for previous dates
            const today = new Date().toISOString().split('T')[0];
            if (date < today && !loadedFromSheets[date][currentCategory]) {
                await fetchAttendanceFromDatabase(date);
            }

            renderStudentList();
        }

        // Fetch attendance from Google Sheets for a specific date
        async function fetchAttendanceFromDatabase(date) {
            try {
                showIOSLoading('Loading from database...');
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "fetch_reports", date: date, sheetUrl: getSessionSheetUrl() })
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success' && json.data) {
                    let foundData = false;
                    for (const [sheetName, rows] of Object.entries(json.data)) {
                        if (rows && rows.length > 1 && CATEGORIES.includes(sheetName)) {
                            // Parse and populate attendance
                            const headers = rows[0];
                            const nameIdx = headers.indexOf('Full Name');
                            const statusIdx = headers.indexOf('Status');

                            if (nameIdx !== -1 && statusIdx !== -1) {
                                ensureCategoryAttendance(sheetName);
                                for (let i = 1; i < rows.length; i++) {
                                    const name = rows[i][nameIdx];
                                    const status = rows[i][statusIdx];
                                    if (name && ['Present', 'Absent', 'Leave'].includes(status)) {
                                        attendanceByCategory[sheetName][name] = status;
                                    }
                                }
                                if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                                loadedFromSheets[date][sheetName] = true;
                                // Mark as synced since it came from database
                                markAsSynced(date, sheetName);
                                foundData = true;
                            }
                        }
                    }
                    if (foundData) {
                        attendance = attendanceByCategory[currentCategory];
                        showMessage('Loaded from database', 'success');
                    }
                }
            } catch (e) {
                hideIOSLoading();
                // Silent fail, use local data
            }
        }

        function downloadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data', 'error');

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };
            const timeValue = timeValueByCategory[currentCategory] || currentCategory;

            let csv = 'Full Name,Application: Application Number,Application: ID,Hostel Id,Hostel Allocation,Time,Status,Reason,Date\n';

            students.forEach(s => {
                const status = attendance[s.name] || 'Present';
                csv += `${csvEscape(s.name)},${csvEscape(s.appNumber || '')},${csvEscape(s.appId || '')},${csvEscape(s.hostelId || '')},${csvEscape(s.allocation || '')},${csvEscape(timeValue)},${csvEscape(status)},,${csvEscape(date)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${currentCategory}_${date}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMessage('CSV Downloaded', 'success');
        }

        function downloadOverallAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data', 'error');

            try {
                const timeValueByCategory = { 'Yoga': 'Morning', 'Mess Day': 'Morning', 'Mess Night': 'Night', 'Night Shift': 'Night' };
                const wb = XLSX.utils.book_new();

                CATEGORIES.forEach(cat => {
                    ensureCategoryAttendance(cat);
                    const catAtt = attendanceByCategory[cat];
                    const aoa = [['Full Name', 'Application: Application Number', 'Application: ID', 'Hostel Id', 'Hostel Allocation', 'Time', 'Status', 'Reason', 'Date']];

                    students.forEach(s => {
                        const status = catAtt[s.name] || 'Present';
                        aoa.push([
                            s.name,
                            s.appNumber || '',
                            s.appId || '',
                            s.hostelId || '',
                            s.allocation || '',
                            timeValueByCategory[cat] || cat,
                            status,
                            '',
                            date
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    XLSX.utils.book_append_sheet(wb, ws, cat);
                });
                XLSX.writeFile(wb, `Overall_Attendance_${date}.xlsx`);
                showMessage('Overall Excel Downloaded', 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Sync CURRENT section only (Individual Sync)
        async function syncCurrentSection() {
            const date = document.getElementById('attendanceDate').value;
            const category = currentCategory;

            if (!students.length) return showMessage('No data to sync', 'error');

            // Check if already synced
            if (isSynced(date, category)) {
                showMessage(`${category} already synced for ${date}. Cannot re-sync.`, 'warning');
                return;
            }

            // Check if verified
            if (!verifiedCategories[category]) {
                showMessage(`Please verify ${category} first`, 'error');
                return;
            }

            showIOSLoading(`Syncing ${category}...`);

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };

            ensureCategoryAttendance(category);
            const catAtt = attendanceByCategory[category];
            const timeValue = timeValueByCategory[category] || category;

            const rows = [];
            students.forEach(s => {
                const status = catAtt[s.name] || 'Present';
                rows.push([
                    s.name,
                    s.appNumber || '',
                    s.appId || '',
                    s.hostelId || '',
                    s.allocation || '',
                    timeValue,
                    status,
                    '',
                    date
                ]);
            });

            const payload = {
                action: "sync_batched_multi_sheet",
                batches: { [category]: rows },
                sheetUrl: getSessionSheetUrl()
            };

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success') {
                    markAsSynced(date, category);
                    clearAttendanceDraft(); // Clear draft after successful sync
                    showMessage(`${category} synced successfully! ðŸ”’`, 'success');
                } else {
                    showMessage(`Sync Failed: ${json.error}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        // Sync ALL sections
        async function syncToGoogleSheet() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to sync', 'error');

            // RESTRICTION: Only allow sync for TODAY's date
            const now = new Date();
            const today = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0');

            if (date !== today) {
                showMessage('âŒ Cannot update past dates! Only today allowed.', 'error');
                return;
            }

            // Check which categories are already synced
            const alreadySynced = CATEGORIES.filter(c => isSynced(date, c));
            const notSynced = CATEGORIES.filter(c => !isSynced(date, c));

            if (alreadySynced.length === CATEGORIES.length) {
                showMessage('All sections already synced for this date!', 'warning');
                return;
            }

            // Check verification for non-synced categories
            const unverified = notSynced.filter(c => !verifiedCategories[c]);
            if (unverified.length > 0) {
                showMessage(`Verify first: ${unverified.join(', ')}`, 'error');
                return;
            }

            let confirmMsg = `Sync ${notSynced.join(', ')} for ${date}?`;
            if (alreadySynced.length > 0) {
                confirmMsg += `\n\n(${alreadySynced.join(', ')} already synced - will be skipped)`;
            }
            if (!confirm(confirmMsg)) return;

            showIOSLoading('Syncing all sections...');

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };

            // Prepare batches only for non-synced categories
            const batches = {};

            for (const cat of notSynced) {
                ensureCategoryAttendance(cat);
                const catAtt = attendanceByCategory[cat];
                const timeValue = timeValueByCategory[cat] || cat;

                const rows = [];
                students.forEach(s => {
                    const status = catAtt[s.name] || 'Present';
                    rows.push([
                        s.name,
                        s.appNumber || '',
                        s.appId || '',
                        s.hostelId || '',
                        s.allocation || '',
                        timeValue,
                        status,
                        '',
                        date
                    ]);
                });

                batches[cat] = rows;
            }

            const payload = {
                action: "sync_batched_multi_sheet",
                batches: batches,
                sheetUrl: getSessionSheetUrl()
            };

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success') {
                    // Mark all synced categories
                    notSynced.forEach(cat => markAsSynced(date, cat));
                    clearAttendanceDraft(); // Clear draft after successful sync
                    showMessage('Sync Completed! All sections locked ðŸ”’', 'success');
                } else {
                    showMessage(`Sync Failed: ${json.error}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        function resetAttendance() {
            const date = document.getElementById('attendanceDate').value;

            // Don't allow reset if synced
            if (isSynced(date, currentCategory)) {
                showMessage(`Cannot reset ${currentCategory} - already synced!`, 'error');
                return;
            }

            if (confirm('Reset current list to Present?')) {
                students.forEach(s => attendanceByCategory[currentCategory][s.name] = 'Present');
                attendance = attendanceByCategory[currentCategory];
                renderStudentList();
                showMessage('Reset Complete', 'info');
            }
        }

        // iOS-style showMessage (maps to iOS toast)
        function showMessage(msg, type) {
            showIOSToast(msg, type);
        }

        // --- Admin Panel Password ---
        const ADMIN_PASSWORD = '26vv13'; // Change this to your actual password

        // --- Admin Panel Logic ---
        function openAdminLogin() {
            closeDrawer();
            // Show iOS authentication sheet instead of opening directly
            showIOSAuth();
        }

        // Show iOS Authentication Sheet
        function showIOSAuth() {
            const overlay = document.getElementById('iosAuthOverlay');
            const input = document.getElementById('iosAuthPassword');
            const error = document.getElementById('iosAuthError');

            // Reset state
            input.value = '';
            input.classList.remove('error');
            error.classList.remove('visible');

            // Show overlay
            overlay.classList.add('visible');

            // Focus input after animation
            setTimeout(() => input.focus(), 300);
        }

        // Close iOS Authentication Sheet
        function closeIOSAuth() {
            const overlay = document.getElementById('iosAuthOverlay');
            const sheet = overlay.querySelector('.ios-auth-sheet');

            overlay.classList.remove('visible');
            sheet.classList.remove('shake');
        }

        // Submit iOS Authentication
        function submitIOSAuth() {
            const input = document.getElementById('iosAuthPassword');
            const error = document.getElementById('iosAuthError');
            const sheet = document.querySelector('.ios-auth-sheet');
            const enteredPassword = input.value;

            // Validate password
            if (enteredPassword === ADMIN_PASSWORD) {
                // Success - close sheet and open Admin Panel
                closeIOSAuth();
                showAdminPanel();
                showIOSToast('Access Granted', 'success');
            } else {
                // Error - shake and show error
                sheet.classList.add('shake');
                input.classList.add('error');
                error.classList.add('visible');

                // Remove shake class after animation
                setTimeout(() => sheet.classList.remove('shake'), 500);

                // Clear input
                input.value = '';
                input.focus();
            }
        }

        // Handle Enter key in password field
        document.addEventListener('DOMContentLoaded', function () {
            const authInput = document.getElementById('iosAuthPassword');
            if (authInput) {
                authInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        submitIOSAuth();
                    }
                });
            }
        });

        function showAdminPanel() {
            // Hide FAB to prevent overlap
            const fabContainer = document.querySelector('.fab-container');
            if (fabContainer) fabContainer.style.display = 'none';

            const main = document.querySelector('main.content');
            main.innerHTML = `
                <!-- Admin Header -->
                <div class="admin-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; border-radius:12px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-symbols-outlined" style="color:white;">arrow_back</span>
                        </button>
                        <div>
                            <div class="admin-header-title">Admin Panel</div>
                            <div class="admin-header-subtitle">v6.0 â€¢ Rankings & AI Insights</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="admin-tabs-new">
                    <button class="admin-tab-new active" id="tab-overview" onclick="switchAdminTabNew('overview')">
                        <span class="material-symbols-outlined">dashboard</span>
                        Overview
                    </button>
                    <button class="admin-tab-new" id="tab-rankings" onclick="switchAdminTabNew('rankings')">
                        <span class="material-symbols-outlined">leaderboard</span>
                        Rankings
                    </button>
                    <button class="admin-tab-new" id="tab-ai" onclick="switchAdminTabNew('ai')">
                        <span class="material-symbols-outlined">psychology</span>
                        AI Insights
                    </button>
                    <button class="admin-tab-new" id="tab-reports" onclick="switchAdminTabNew('reports')">
                        <span class="material-symbols-outlined">download</span>
                        Reports
                    </button>
                </div>

                <!-- Overview Section -->
                <div id="section-overview" class="admin-section active">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div style="background:transparent; border:1.5px solid rgba(0,122,255,0.3); border-radius:20px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:#007AFF;" id="totalStudentsOverview">-</div>
                            <div style="font-size:12px; color:#666; margin-top:4px;" id="totalStudentsLabel">ðŸ“Š Total Students</div>
                        </div>
                        <div style="background:transparent; border:1.5px solid rgba(52,199,89,0.3); border-radius:20px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:#34C759;" id="avgAttendanceOverview">-</div>
                            <div style="font-size:12px; color:#666; margin-top:4px;" id="avgAttendanceLabel">ðŸ“ˆ Avg Attendance</div>
                        </div>
                        <div style="background:transparent; border:1.5px solid rgba(255,149,0,0.3); border-radius:20px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:#FF9500;" id="sectionStudentsCount">-</div>
                            <div style="font-size:12px; color:#666; margin-top:4px;" id="sectionStudentsLabel">ðŸ§‘â€ðŸŽ“ Section Students</div>
                        </div>
                        <div style="background:transparent; border:1.5px solid rgba(255,59,48,0.3); border-radius:20px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:#FF3B30;" id="atRiskCount">-</div>
                            <div style="font-size:12px; color:#666; margin-top:4px;" id="atRiskLabel">âš ï¸ At Risk</div>
                        </div>
                    </div>
                    <div id="overviewContent" style="margin-top:16px;">
                        <div class="empty-state">
                            <span class="material-symbols-outlined">sync</span>
                            <div>Loading data...</div>
                        </div>
                    </div>
                </div>

                <!-- Rankings Section -->
                <div id="section-rankings" class="admin-section">
                    <!-- Search Bar -->
                    <div style="margin-bottom:12px; position:relative;">
                        <span class="material-symbols-outlined" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--md-sys-color-outline); font-size:20px;">search</span>
                        <input type="text" id="rankingSearch" placeholder="Search student..." oninput="filterRankings(currentRankingFilter)"
                            style="width:100%; padding:12px 12px 12px 44px; border:1px solid var(--md-sys-color-outline-variant); border-radius:12px; background:var(--md-sys-color-surface); font-size:15px; color:var(--md-sys-color-on-surface);">
                    </div>
                    
                    <!-- Date Filter -->
                    <div style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                        <select id="rankingDateType" onchange="toggleRankingDateFilter()" 
                            style="padding:10px 12px; border:1px solid var(--md-sys-color-outline-variant); border-radius:10px; background:var(--md-sys-color-surface); font-size:14px; color:var(--md-sys-color-on-surface);">
                            <option value="all">ðŸ“… All Time</option>
                            <option value="month">ðŸ“† By Month</option>
                            <option value="range">ðŸ“Š Date Range</option>
                        </select>
                        
                        <input type="month" id="rankingMonth" onchange="renderRankings()" 
                            style="display:none; padding:10px 12px; border:1px solid var(--md-sys-color-outline-variant); border-radius:10px; background:var(--md-sys-color-surface); font-size:14px; color:var(--md-sys-color-on-surface);">
                        
                        <div id="rankingDateRange" style="display:none; flex:1; display:flex; gap:8px; align-items:center;">
                            <input type="date" id="rankingStartDate" onchange="renderRankings()" 
                                style="flex:1; padding:10px; border:1px solid var(--md-sys-color-outline-variant); border-radius:10px; background:var(--md-sys-color-surface); font-size:13px; color:var(--md-sys-color-on-surface);">
                            <span style="color:var(--md-sys-color-outline);">to</span>
                            <input type="date" id="rankingEndDate" onchange="renderRankings()" 
                                style="flex:1; padding:10px; border:1px solid var(--md-sys-color-outline-variant); border-radius:10px; background:var(--md-sys-color-surface); font-size:13px; color:var(--md-sys-color-on-surface);">
                        </div>
                    </div>
                    
                    <div class="filter-pills" id="rankingFilters">
                        <button class="filter-pill active" onclick="filterRankings('All')">All</button>
                        <button class="filter-pill" onclick="filterRankings('Yoga')">ðŸ§˜ Yoga</button>
                        <button class="filter-pill" onclick="filterRankings('Night Shift')">ðŸŒ™ Night Shift</button>
                        <button class="filter-pill" onclick="filterRankings('Mess Day')">â˜€ï¸ Mess Day</button>
                        <button class="filter-pill" onclick="filterRankings('Mess Night')">ðŸŒƒ Mess Night</button>
                    </div>
                    <div id="rankingsContent">
                        <div class="empty-state">
                            <span class="material-symbols-outlined">leaderboard</span>
                            <div>Loading rankings...</div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Section - iOS Style -->
                <div id="section-ai" class="admin-section">
                    <div class="ios-section-header">
                        <h3 class="ios-section-title">AI Attendance Analysis</h3>
                        <p class="ios-section-subtitle">Intelligent insights based on attendance patterns</p>
                    </div>
                    <div class="ios-filter-scroll" id="aiFilters">
                        <button class="ios-filter-chip active" onclick="filterAIInsights('All')">All</button>
                        <button class="ios-filter-chip" onclick="filterAIInsights('Yoga')">Yoga</button>
                        <button class="ios-filter-chip" onclick="filterAIInsights('Mess Day')">Mess Day</button>
                        <button class="ios-filter-chip" onclick="filterAIInsights('Mess Night')">Mess Night</button>
                        <button class="ios-filter-chip" onclick="filterAIInsights('Night Shift')">Night Shift</button>
                    </div>
                    <div id="aiContent">
                        <div class="ios-insight-card ios-empty-card">
                            <div class="ios-empty-icon" style="background: rgba(0,122,255,0.12); color: #007AFF;">â³</div>
                            <div class="ios-empty-title">Analyzing Patterns</div>
                            <div class="ios-empty-subtitle">Loading attendance data...</div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="section-reports" class="admin-section">
                    <div class="stat-card" style="margin-bottom:16px;">
                        <h3 style="margin:0 0 12px 0; font-size:16px; color:var(--md-sys-color-primary);">ðŸ“Š Section-wise Report Download</h3>
                        
                        <!-- Section Filter -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Section</label>
                            <select id="reportSection" class="date-input" style="width:100%; margin-top:8px;">
                                <option value="All">All Sections</option>
                                <option value="Yoga">ðŸ§˜ Yoga</option>
                                <option value="Mess Day">â˜€ï¸ Mess Day</option>
                                <option value="Mess Night">ðŸŒƒ Mess Night</option>
                                <option value="Night Shift">ðŸŒ™ Night Shift</option>
                            </select>
                        </div>

                        <!-- Period Selector -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Period</label>
                            <select id="reportPeriod" class="date-input" style="width:100%; margin-top:8px;" onchange="toggleReportPeriod()">
                                <option value="month">By Month</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>

                        <!-- Month Selector (shown when By Month) -->
                        <div id="monthSelector" style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Month</label>
                            <input type="month" id="reportMonth" class="date-input" style="width:100%; margin-top:8px;">
                        </div>

                        <!-- Custom Date Range (hidden by default) -->
                        <div id="customDateRange" style="display:none; margin-bottom:16px;">
                            <div style="display:flex; gap:8px;">
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:gray;">From</label>
                                    <input type="date" id="reportStartDate" class="date-input" style="width:100%; margin-top:4px;">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:gray;">To</label>
                                    <input type="date" id="reportEndDate" class="date-input" style="width:100%; margin-top:4px;">
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button onclick="downloadSectionReport('excel')" class="fab" style="flex:1; justify-content:center; position:static; margin:0;">
                                <span class="material-symbols-outlined">description</span> Excel
                            </button>
                            <button onclick="downloadSectionReport('pdf')" class="fab" style="flex:1; justify-content:center; position:static; margin:0; background:linear-gradient(135deg, #FF3B30, #FF6B6B);">
                                <span class="material-symbols-outlined">picture_as_pdf</span> PDF
                            </button>
                        </div>
                        <div id="reportMsg" style="margin-top:12px; font-weight:500;"></div>
                    </div>

                    <div class="stat-card">
                        <h3 style="margin:0 0 12px 0; font-size:16px; color:var(--md-sys-color-primary);">ðŸ“¥ Quick Daily Report</h3>
                        <div class="date-input-container" style="margin-bottom:12px;">
                            <span class="material-symbols-outlined date-input-icon">calendar_today</span>
                            <input type="date" id="reportDate" class="date-input">
                        </div>
                        <button class="fab" onclick="fetchAndDownloadReport()" style="width:100%; justify-content:center; position:static; margin:0;">
                            <span class="material-symbols-outlined">cloud_download</span> Download
                        </button>
                        <div id="adminMsg" style="margin-top:12px; font-weight:500;"></div>
                    </div>
                </div>
            `;

            // Set today's date and current month
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = today.substring(0, 7); // YYYY-MM format
            document.getElementById('reportDate').value = today;
            document.getElementById('reportMonth').value = currentMonth;

            // Load tracking data and render overview
            loadAdminData();
        }

        // New Tab Switching for Admin v6.0
        function switchAdminTabNew(tab) {
            document.querySelectorAll('.admin-tab-new').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${tab}`).classList.add('active');
        }

        // Load all admin data - always fetch fresh for hostel-specific data
        async function loadAdminData() {
            // Clear cache to ensure fresh hostel-specific data
            window.trackingDataCache = null;
            await fetchTrackingDataForAdmin();
        }

        async function fetchTrackingDataForAdmin() {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "get_tracking_data", sheetUrl: getSessionSheetUrl() })
                });
                const json = await res.json();
                if (json.result === 'success') {
                    window.trackingDataCache = json.data;
                    renderAdminOverview();
                    renderRankings();
                    renderAIInsights();
                }
            } catch (e) {
                console.error('Failed to fetch tracking data:', e);
            }
        }

        // Calculate student scores
        function calculateStudentScores() {
            if (!window.trackingDataCache) return [];

            return window.trackingDataCache.map(item => {
                const total = item.total || 0;
                const present = item.present || 0;
                const score = total > 0 ? Math.round((present / total) * 100) : 0;

                let tier = 'normal';
                if (score >= 90) tier = 'gold';
                else if (score >= 75) tier = 'silver';
                else if (score >= 50) tier = 'bronze';
                else tier = 'at-risk';

                return { ...item, score, tier };
            }).sort((a, b) => b.score - a.score);
        }

        // Render Overview
        function renderAdminOverview() {
            // Build content with section filter first
            const container = document.getElementById('overviewContent');

            let html = `
                <div style="margin-bottom:16px;">
                    <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Section</label>
                    <select id="overviewSection" class="date-input" style="width:100%; margin-top:8px;" onchange="updateOverviewStats()">
                        <option value="All">All Sections</option>
                        <option value="Yoga">ðŸ§˜ Yoga</option>
                        <option value="Mess Day">â˜€ï¸ Mess Day</option>
                        <option value="Mess Night">ðŸŒƒ Mess Night</option>
                        <option value="Night Shift">ðŸŒ™ Night Shift</option>
                    </select>
                </div>
                <div id="overviewTop5Container"></div>
            `;
            container.innerHTML = html;

            // Render stats for default selection (All)
            updateOverviewStats();
        }

        // Update all stats based on section selection
        function updateOverviewStats() {
            const section = document.getElementById('overviewSection').value;
            const allScores = calculateStudentScores();

            // Filter by section
            let scores = section === 'All' ? allScores : allScores.filter(s => s.category === section);

            // Calculate stats for selected section
            const totalStudents = scores.length;
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b.score, 0) / scores.length) : 0;
            const sectionCount = scores.length;
            const atRisk = scores.filter(s => s.tier === 'at-risk').length;

            // Update stat cards
            document.getElementById('totalStudentsOverview').textContent = totalStudents;
            document.getElementById('avgAttendanceOverview').textContent = avgScore + '%';
            document.getElementById('sectionStudentsCount').textContent = sectionCount;
            document.getElementById('atRiskCount').textContent = atRisk;

            // Update labels
            const sectionLabel = section === 'All' ? 'All Sections' : section;
            document.getElementById('totalStudentsLabel').textContent = `ðŸ“Š ${sectionLabel}`;
            document.getElementById('avgAttendanceLabel').textContent = `ðŸ“ˆ Avg (${sectionLabel})`;
            document.getElementById('sectionStudentsLabel').textContent = `ðŸ§‘â€ðŸŽ“ ${sectionLabel}`;
            document.getElementById('atRiskLabel').textContent = `âš ï¸ At Risk (${sectionLabel})`;

            // Update Top 5
            const top5 = scores.slice(0, 5);
            const topContainer = document.getElementById('overviewTop5Container');

            let html = `<h4 style="margin:0 0 12px 0; font-size:14px; color:var(--md-sys-color-on-surface-variant);">ðŸ† Top 5 ${sectionLabel}</h4>`;

            if (top5.length === 0) {
                html += '<div class="empty-state"><span class="material-symbols-outlined">search_off</span><div>No students in this section</div></div>';
            } else {
                top5.forEach((student, i) => {
                    const tierClass = student.tier;
                    const scoreClass = student.score >= 90 ? 'score-excellent' : student.score >= 75 ? 'score-good' : student.score >= 50 ? 'score-warning' : 'score-danger';
                    const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1);
                    const escapedName = student.name.replace(/'/g, "\\'");
                    html += `
                        <div class="ranking-card" onclick="openStudentDashboardFromRanking('${escapedName}', '${student.category}')" style="cursor:pointer; display:flex; align-items:center; padding:14px; gap:12px;">
                            <div class="ranking-position ${tierClass}" style="width:36px; text-align:center; font-size:18px;">${medal}</div>
                            <div class="ranking-info" style="flex:1;">
                                <div class="ranking-name" style="font-size:15px; font-weight:600; color:#1C1C1E;">${student.name}</div>
                                <div style="font-size:12px; color:#8E8E93; margin-top:2px;">${student.category}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:20px; font-weight:700; color:#007AFF;">${student.score}%</div>
                            </div>
                        </div>
                    `;
                });
            }

            topContainer.innerHTML = html;
        }

        // Render Rankings
        let currentRankingFilter = 'All';

        function filterRankings(category) {
            currentRankingFilter = category;
            document.querySelectorAll('#rankingFilters .filter-pill').forEach(p => {
                p.classList.toggle('active', p.textContent.includes(category) || (category === 'All' && p.textContent === 'All'));
            });
            renderRankings();
        }

        // Toggle date filter visibility
        function toggleRankingDateFilter() {
            const type = document.getElementById('rankingDateType').value;
            const monthInput = document.getElementById('rankingMonth');
            const rangeDiv = document.getElementById('rankingDateRange');

            monthInput.style.display = type === 'month' ? 'block' : 'none';
            rangeDiv.style.display = type === 'range' ? 'flex' : 'none';

            // Set default values
            if (type === 'month' && !monthInput.value) {
                const now = new Date();
                monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }
            if (type === 'range') {
                const startDate = document.getElementById('rankingStartDate');
                const endDate = document.getElementById('rankingEndDate');
                if (!startDate.value) {
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    startDate.value = firstDay.toISOString().split('T')[0];
                }
                if (!endDate.value) {
                    endDate.value = new Date().toISOString().split('T')[0];
                }
            }

            renderRankings();
        }

        // Get date filter range
        function getRankingDateFilter() {
            const type = document.getElementById('rankingDateType')?.value || 'all';

            if (type === 'all') return null; // No filter

            if (type === 'month') {
                const month = document.getElementById('rankingMonth').value;
                if (!month) return null;
                const [year, mo] = month.split('-');
                const startDate = `${year}-${mo}-01`;
                const lastDay = new Date(year, parseInt(mo), 0).getDate();
                const endDate = `${year}-${mo}-${String(lastDay).padStart(2, '0')}`;
                return { startDate, endDate };
            }

            if (type === 'range') {
                const startDate = document.getElementById('rankingStartDate').value;
                const endDate = document.getElementById('rankingEndDate').value;
                if (!startDate || !endDate) return null;
                return { startDate, endDate };
            }

            return null;
        }

        async function renderRankings() {
            const container = document.getElementById('rankingsContent');
            const dateFilter = getRankingDateFilter();

            // If date filter is applied and different from cached data, refetch
            if (dateFilter) {
                container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">hourglass_empty</span><div>Loading...</div></div>';

                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "get_tracking_data",
                            startDate: dateFilter.startDate,
                            endDate: dateFilter.endDate,
                            sheetUrl: getSessionSheetUrl()
                        })
                    });
                    const json = await res.json();
                    if (json.result === 'success') {
                        window.rankingDataFiltered = json.data;
                    }
                } catch (e) {
                    container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">error</span><div>Failed to fetch data</div></div>';
                    return;
                }
            } else {
                window.rankingDataFiltered = null; // Use default cache
            }

            // Use filtered data or cached data
            const dataSource = window.rankingDataFiltered || window.trackingDataCache || [];

            const scores = dataSource.map(item => {
                const present = item.present || 0;
                const absent = item.absent || 0;
                const total = item.total || 0;

                // For Yoga: Score based only on Present vs Absent (Leave not counted)
                // For others: Score based on Present vs Total
                let score = 0;
                if (item.category === 'Yoga') {
                    const yogaTotal = present + absent;
                    score = yogaTotal > 0 ? Math.round((present / yogaTotal) * 100) : 0;
                } else {
                    score = total > 0 ? Math.round((present / total) * 100) : 0;
                }

                let tier = 'normal';
                if (score >= 90) tier = 'gold';
                else if (score >= 75) tier = 'silver';
                else if (score >= 50) tier = 'bronze';
                else tier = 'at-risk';

                return { ...item, score, tier };
            }).sort((a, b) => b.score - a.score);

            const searchQuery = (document.getElementById('rankingSearch')?.value || '').toLowerCase().trim();

            // Filter by category first
            let filtered = currentRankingFilter === 'All'
                ? scores
                : scores.filter(s => s.category === currentRankingFilter);

            // Store original rank (before search filter) - rank 1 is first
            filtered.forEach((student, index) => {
                student.originalRank = index + 1;
            });

            // Then filter by search query (ranks are preserved)
            if (searchQuery) {
                filtered = filtered.filter(s => s.name.toLowerCase().includes(searchQuery));
            }


            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">search_off</span><div>No students found</div></div>';
                return;
            }

            let html = '';
            filtered.forEach((student) => {
                const tierClass = student.tier;
                const scoreClass = student.score >= 90 ? 'score-excellent' : student.score >= 75 ? 'score-good' : student.score >= 50 ? 'score-warning' : 'score-danger';

                // Use original rank (stored in student object), not filtered index
                const rank = student.originalRank;
                const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : rank;

                // Use name + category for reliable lookup
                const escapedName = student.name.replace(/'/g, "\\'");
                html += `
                    <div class="ranking-card" onclick="openStudentDashboardFromRanking('${escapedName}', '${student.category}')" style="cursor:pointer; display:flex; align-items:center; padding:14px; gap:12px;">
                        <div class="ranking-position ${tierClass}" style="width:36px; text-align:center; font-size:18px;">${medal}</div>
                        <div class="ranking-info" style="flex:1;">
                            <div class="ranking-name" style="font-size:15px; font-weight:600; color:#1C1C1E;">${student.name}</div>
                            <div style="font-size:12px; color:#8E8E93; margin-top:2px;">${student.category}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px; font-weight:700; color:#007AFF;">${student.score}%</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render AI Insights - Use iOS styled version
        function renderAIInsights() {
            // Initialize filter to 'All' and render with iOS styling
            currentAIFilter = 'All';
            renderAIInsightsFiltered();
        }

        // AI Insights Filter
        let currentAIFilter = 'All';

        function filterAIInsights(category) {
            currentAIFilter = category;
            document.querySelectorAll('#aiFilters .ios-filter-chip').forEach(p => {
                p.classList.toggle('active', p.textContent === category || (category === 'All' && p.textContent === 'All'));
            });
            renderAIInsightsFiltered();
        }

        function renderAIInsightsFiltered() {
            let scores = calculateStudentScores();
            const container = document.getElementById('aiContent');

            // Apply section filter
            if (currentAIFilter !== 'All') {
                scores = scores.filter(s => s.category === currentAIFilter);
            }

            // Categorize issues
            const criticalAbsent = scores.filter(s => s.score < 50 && s.total >= 5);
            const excessiveLeave = scores.filter(s => s.total > 0 && (s.leave / s.total) > 0.3);
            const perfectAttendance = scores.filter(s => s.score === 100 && s.total >= 5);

            let html = `
                <div class="ios-insights-header">
                    <span class="ios-insights-subtitle">${currentAIFilter === 'All' ? 'All Sections' : currentAIFilter}</span>
                    <span class="ios-insights-count">${scores.length} records analyzed</span>
                </div>
            `;

            // Critical: Low Attendance Card
            if (criticalAbsent.length > 0) {
                const studentItems = criticalAbsent.slice(0, 5).map(s => `
                    <div class="ios-insight-student">
                        <span class="ios-insight-name">${s.name}</span>
                        <span class="ios-insight-value critical">${s.score}%</span>
                    </div>
                `).join('');

                html += `
                    <div class="ios-insight-card">
                        <div class="ios-insight-header">
                            <span class="ios-status-dot critical"></span>
                            <span class="ios-insight-title">Critical: Low Attendance</span>
                            <span class="ios-insight-badge critical">${criticalAbsent.length}</span>
                        </div>
                        <div class="ios-insight-body">
                            ${studentItems}
                            ${criticalAbsent.length > 5 ? `<div class="ios-insight-more">... and ${criticalAbsent.length - 5} more</div>` : ''}
                        </div>
                        <div class="ios-insight-recommendation">
                            <span class="ios-rec-icon">ðŸ’¡</span>
                            <span>Schedule counseling sessions for students with attendance below 50%</span>
                        </div>
                    </div>
                `;
            }

            // Warning: Excessive Leave Card
            if (excessiveLeave.length > 0) {
                const studentItems = excessiveLeave.slice(0, 5).map(s => `
                    <div class="ios-insight-student">
                        <span class="ios-insight-name">${s.name}</span>
                        <span class="ios-insight-value warning">${s.leave} leaves (${Math.round((s.leave / s.total) * 100)}%)</span>
                    </div>
                `).join('');

                html += `
                    <div class="ios-insight-card">
                        <div class="ios-insight-header">
                            <span class="ios-status-dot warning"></span>
                            <span class="ios-insight-title">Excessive Leave Pattern</span>
                            <span class="ios-insight-badge warning">${excessiveLeave.length}</span>
                        </div>
                        <div class="ios-insight-body">
                            ${studentItems}
                            ${excessiveLeave.length > 5 ? `<div class="ios-insight-more">... and ${excessiveLeave.length - 5} more</div>` : ''}
                        </div>
                        <div class="ios-insight-recommendation">
                            <span class="ios-rec-icon">ðŸ’¡</span>
                            <span>Review leave patterns and verify documentation</span>
                        </div>
                    </div>
                `;
            }

            // Positive: Perfect Attendance Card
            if (perfectAttendance.length > 0) {
                const studentItems = perfectAttendance.slice(0, 5).map(s => `
                    <div class="ios-insight-student">
                        <span class="ios-insight-name">${s.name}</span>
                        <span class="ios-insight-value positive">100%</span>
                    </div>
                `).join('');

                html += `
                    <div class="ios-insight-card">
                        <div class="ios-insight-header">
                            <span class="ios-status-dot positive"></span>
                            <span class="ios-insight-title">Perfect Attendance</span>
                            <span class="ios-insight-badge positive">${perfectAttendance.length}</span>
                        </div>
                        <div class="ios-insight-body">
                            ${studentItems}
                            ${perfectAttendance.length > 5 ? `<div class="ios-insight-more">... and ${perfectAttendance.length - 5} more</div>` : ''}
                        </div>
                        <div class="ios-insight-recommendation">
                            <span class="ios-rec-icon">ðŸ’¡</span>
                            <span>Consider recognition or rewards for these dedicated students</span>
                        </div>
                    </div>
                `;
            }

            // No issues state
            if (criticalAbsent.length === 0 && excessiveLeave.length === 0 && perfectAttendance.length === 0) {
                html += `
                    <div class="ios-insight-card ios-empty-card">
                        <div class="ios-empty-icon">âœ“</div>
                        <div class="ios-empty-title">No Issues Detected</div>
                        <div class="ios-empty-subtitle">All students have satisfactory attendance</div>
                    </div>
                `;
            }

            // Summary & Recommendations Card
            if (criticalAbsent.length > 0 || excessiveLeave.length > 0) {
                html += `
                    <div class="ios-insight-card ios-summary-card">
                        <div class="ios-insight-header">
                            <span class="ios-status-dot info"></span>
                            <span class="ios-insight-title">Recommendations</span>
                        </div>
                        <div class="ios-recommendations-list">
                            ${criticalAbsent.length > 0 ? `<div class="ios-rec-item">â€¢ Contact parents of students with critical low attendance</div>` : ''}
                            ${excessiveLeave.length > 0 ? `<div class="ios-rec-item">â€¢ Review leave approval policies and patterns</div>` : ''}
                            <div class="ios-rec-item">â€¢ Generate detailed report for administrative review</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Toggle Period Selector
        function toggleReportPeriod() {
            const period = document.getElementById('reportPeriod').value;
            document.getElementById('monthSelector').style.display = period === 'month' ? 'block' : 'none';
            document.getElementById('customDateRange').style.display = period === 'custom' ? 'block' : 'none';
        }

        // Section-wise Report Download
        function downloadSectionReport(format) {
            if (!window.trackingDataCache || window.trackingDataCache.length === 0) {
                alert('No tracking data available. Please load data first.');
                return;
            }

            const section = document.getElementById('reportSection').value;
            const period = document.getElementById('reportPeriod').value;
            let startDate, endDate;

            if (period === 'month') {
                const monthVal = document.getElementById('reportMonth').value;
                if (!monthVal) {
                    alert('Please select a month');
                    return;
                }
                const [year, month] = monthVal.split('-');
                startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else {
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
            }

            // Filter data
            let filteredData = window.trackingDataCache;

            // Filter by section
            if (section !== 'All') {
                filteredData = filteredData.filter(s => s.category === section);
            }

            if (filteredData.length === 0) {
                alert('No data found for selected filters');
                return;
            }

            const msgEl = document.getElementById('reportMsg');
            msgEl.textContent = 'Generating report...';
            msgEl.style.color = 'var(--md-sys-color-primary)';

            if (format === 'excel') {
                // Generate Excel
                const exportData = [
                    [`Section Report: ${section}`],
                    [`Period: ${startDate} to ${endDate}`],
                    [`Generated: ${new Date().toLocaleDateString()}`],
                    [],
                    ['Student Name', 'Category', 'Present', 'Absent', 'Leave', 'Total', 'Score %']
                ];

                filteredData.forEach(item => {
                    const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                    exportData.push([item.name, item.category, item.present, item.absent, item.leave, item.total, score]);
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, section === 'All' ? 'All Sections' : section);
                XLSX.writeFile(wb, `${section}_Report_${startDate}_to_${endDate}.xlsx`);

                msgEl.textContent = 'âœ“ Excel downloaded!';
                msgEl.style.color = '#34C759';
            } else {
                // Generate PDF
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(18);
                    doc.setTextColor(0, 122, 255);
                    doc.text(`${section} Report`, 14, 20);

                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(`Period: ${startDate} to ${endDate}`, 14, 30);
                    doc.text(`Total Students: ${filteredData.length}`, 14, 35);

                    const tableBody = filteredData.map(item => {
                        const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                        return [item.name, item.present, item.absent, item.leave, item.total, score + '%'];
                    });

                    doc.autoTable({
                        startY: 42,
                        head: [['Student', 'Present', 'Absent', 'Leave', 'Total', 'Score']],
                        body: tableBody,
                        theme: 'striped',
                        headStyles: { fillColor: [0, 122, 255] }
                    });

                    doc.save(`${section}_Report_${startDate}_to_${endDate}.pdf`);

                    msgEl.textContent = 'âœ“ PDF downloaded!';
                    msgEl.style.color = '#34C759';
                } catch (e) {
                    msgEl.textContent = 'PDF Error: ' + e.message;
                    msgEl.style.color = '#FF3B30';
                }
            }
        }

        // Open Student Dashboard from Rankings - Fixed to use name+category lookup
        function openStudentDashboardFromRanking(studentName, studentCategory) {
            // Get the current data source (same as renderRankings uses)
            const dataSource = window.rankingDataFiltered || window.trackingDataCache || [];

            // Find the student by name AND category for reliable lookup
            const student = dataSource.find(s =>
                s.name === studentName && s.category === studentCategory
            );

            if (!student) {
                console.error('Student not found:', studentName, studentCategory);
                alert('Student data not found. Please refresh and try again.');
                return;
            }

            // Calculate score for display
            const present = student.present || 0;
            const absent = student.absent || 0;
            const total = student.total || 0;
            let score = 0;
            if (studentCategory === 'Yoga') {
                const yogaTotal = present + absent;
                score = yogaTotal > 0 ? Math.round((present / yogaTotal) * 100) : 0;
            } else {
                score = total > 0 ? Math.round((present / total) * 100) : 0;
            }

            // Get modal elements
            const modal = document.getElementById('studentDashboardModal');
            const nameEl = document.getElementById('dashboardStudentName');
            const categoryEl = document.getElementById('dashboardCategory');
            const presentEl = document.getElementById('dashPresent');
            const absentEl = document.getElementById('dashAbsent');
            const leaveEl = document.getElementById('dashLeave');
            const detailsEl = document.getElementById('dashboardDateDetails');

            if (!modal || !nameEl) {
                console.error('Modal elements not found. Modal:', modal, 'NameEl:', nameEl);
                alert('Dashboard modal not loaded. Please refresh the page.');
                return;
            }

            // Update modal header
            nameEl.textContent = student.name;
            categoryEl.textContent = student.category + ' â€¢ Score: ' + score + '%';

            // Update summary counts
            presentEl.textContent = student.present || 0;
            absentEl.textContent = student.absent || 0;
            leaveEl.textContent = student.leave || 0;

            // Build date details HTML
            let detailsHtml = '';

            // Helper function to group dates by year
            function groupDatesByYear(dates) {
                if (!dates || dates.length === 0) return {};

                const grouped = {};
                dates.forEach(dateStr => {
                    try {
                        const date = new Date(dateStr);
                        const year = date.getFullYear();
                        if (!grouped[year]) grouped[year] = [];
                        grouped[year].push(dateStr);
                    } catch (e) {
                        // Skip invalid dates
                    }
                });

                // Sort dates within each year (newest first)
                Object.keys(grouped).forEach(year => {
                    grouped[year].sort((a, b) => new Date(b) - new Date(a));
                });

                return grouped;
            }

            // Helper function to format date as "Jan-14"
            function formatDatePill(dateStr) {
                try {
                    const date = new Date(dateStr);
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${months[date.getMonth()]}-${day}`;
                } catch (e) {
                    return dateStr;
                }
            }

            // Helper function to build year-grouped dates HTML with collapsible sections
            function buildYearGroupedDates(dates, bgColor, textColor, sectionPrefix) {
                if (!dates || dates.length === 0) return '<div style="color:#8E8E93; font-size:13px; padding:8px 0;">No records</div>';

                const grouped = groupDatesByYear(dates);
                const years = Object.keys(grouped).sort((a, b) => b - a); // Descending order
                const MAX_VISIBLE = 10; // Default visible dates per year

                // Store in global cache for expand/collapse
                const cacheId = sectionPrefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                window._yearDateCache = window._yearDateCache || {};
                window._yearDateCache[cacheId] = { grouped, bgColor, textColor };

                let html = '';
                years.forEach((year, idx) => {
                    const yearDates = grouped[year];
                    const hasMore = yearDates.length > MAX_VISIBLE;
                    const sectionId = `${cacheId}_${year}`;
                    const visibleDates = hasMore ? yearDates.slice(0, MAX_VISIBLE) : yearDates;

                    html += `<div style="margin-bottom:12px;">
                        <div onclick="toggleYearSection('${sectionId}', '${cacheId}', '${year}')" 
                             style="font-weight:600; font-size:14px; color:#3C3C43; margin-bottom:8px; display:flex; align-items:center; gap:6px; cursor:${hasMore ? 'pointer' : 'default'}; user-select:none;">
                            <span id="${sectionId}_arrow" style="color:#8E8E93; font-size:12px; transition:transform 0.2s;">${hasMore ? 'â–¶' : 'â€¢'}</span> 
                            ${year} 
                            ${hasMore ? `<span style="color:#8E8E93; font-size:12px; font-weight:400;">(${yearDates.length} dates)</span>` : ''}
                        </div>
                        <div id="${sectionId}" style="display:flex; flex-wrap:wrap; gap:6px; padding-left:4px;">
                            ${visibleDates.map(d =>
                        `<span style="background:${bgColor}; color:${textColor}; padding:6px 10px; border-radius:8px; font-size:13px; font-weight:500;">${formatDatePill(d)}</span>`
                    ).join('')}
                            ${hasMore ? `<span id="${sectionId}_more" onclick="event.stopPropagation(); toggleYearSection('${sectionId}', '${cacheId}', '${year}')" style="color:#007AFF; cursor:pointer; padding:6px 10px; font-weight:500;">+${yearDates.length - MAX_VISIBLE} more</span>` : ''}
                        </div>
                    </div>`;
                });

                return html;
            }

            // Present dates
            if (student.presentDates && student.presentDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:12px; color:#34C759; font-size:15px;">âœ… Present Days (${student.presentDates.length})</div>
                    <div style="background:#F8F8F8; border-radius:12px; padding:12px;">
                        ${buildYearGroupedDates(student.presentDates, '#d4edda', '#155724', 'present')}
                    </div>
                </div>`;
            }

            // Absent dates
            if (student.absentDates && student.absentDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:12px; color:#FF3B30; font-size:15px;">âŒ Absent Days (${student.absentDates.length})</div>
                    <div style="background:#F8F8F8; border-radius:12px; padding:12px;">
                        ${buildYearGroupedDates(student.absentDates, '#f8d7da', '#721c24', 'absent')}
                    </div>
                </div>`;
            }

            // Leave dates
            if (student.leaveDates && student.leaveDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:12px; color:#FF9500; font-size:15px;">ðŸŸ¡ Leave Days (${student.leaveDates.length})</div>
                    <div style="background:#F8F8F8; border-radius:12px; padding:12px;">
                        ${buildYearGroupedDates(student.leaveDates, '#fff3cd', '#856404', 'leave')}
                    </div>
                </div>`;
            }

            if (detailsHtml === '') {
                detailsHtml = '<div style="text-align:center; color:gray; padding:20px;">No date details available</div>';
            }

            if (detailsEl) {
                detailsEl.innerHTML = detailsHtml;
            }

            // Show modal
            modal.style.display = 'flex';
        }

        function formatDateShort(dateStr) {
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${date.getDate()} ${months[date.getMonth()]}`;
            } catch (e) {
                return dateStr;
            }
        }

        function closeStudentDashboard() {
            document.getElementById('studentDashboardModal').style.display = 'none';
        }

        // Global function to toggle year section expand/collapse
        function toggleYearSection(sectionId, cacheId, year) {
            const cache = window._yearDateCache && window._yearDateCache[cacheId];
            if (!cache) return;

            const container = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId + '_arrow');
            if (!container) return;

            const yearDates = cache.grouped[year];
            if (!yearDates || yearDates.length <= 10) return; // No toggle needed

            const isExpanded = container.dataset.expanded === 'true';

            if (isExpanded) {
                // Collapse: show only first 10
                const visibleHtml = yearDates.slice(0, 10).map(d =>
                    `<span style="background:${cache.bgColor}; color:${cache.textColor}; padding:6px 10px; border-radius:8px; font-size:13px; font-weight:500;">${formatDatePillGlobal(d)}</span>`
                ).join('');
                container.innerHTML = visibleHtml + `<span id="${sectionId}_more" onclick="event.stopPropagation(); toggleYearSection('${sectionId}', '${cacheId}', '${year}')" style="color:#007AFF; cursor:pointer; padding:6px 10px; font-weight:500;">+${yearDates.length - 10} more</span>`;
                container.dataset.expanded = 'false';
                if (arrow) arrow.textContent = 'â–¶';
            } else {
                // Expand: show all dates
                const allHtml = yearDates.map(d =>
                    `<span style="background:${cache.bgColor}; color:${cache.textColor}; padding:6px 10px; border-radius:8px; font-size:13px; font-weight:500;">${formatDatePillGlobal(d)}</span>`
                ).join('');
                container.innerHTML = allHtml + `<span onclick="event.stopPropagation(); toggleYearSection('${sectionId}', '${cacheId}', '${year}')" style="color:#007AFF; cursor:pointer; padding:6px 10px; font-weight:500;">Show less</span>`;
                container.dataset.expanded = 'true';
                if (arrow) arrow.textContent = 'â–¼';
            }
        }

        // Global helper for date formatting (used by toggleYearSection)
        function formatDatePillGlobal(dateStr) {
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const day = String(date.getDate()).padStart(2, '0');
                return `${months[date.getMonth()]}-${day}`;
            } catch (e) {
                return dateStr;
            }
        }

        function downloadTrackingExcel() {
            // Debug Alert - To verify new code is loaded
            // alert("Starting Export V3 (clean columns)"); 

            if (!window.trackingDataCache) return alert("No data to export");

            // Get current filter values to export exactly what the user sees
            const query = document.getElementById('trackSearch').value.toLowerCase();
            const category = document.getElementById('trackCategory').value;
            const startDate = document.getElementById('trackStartDate').value || "All Time";
            const endDate = document.getElementById('trackEndDate').value || "Present";

            // Filter data based on current view
            const dataToExport = window.trackingDataCache.filter(item => {
                const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                    (item.id && String(item.id).toLowerCase().includes(query));
                const matchesCat = category === 'All' || item.category === category;
                return matchesSearch && matchesCat;
            });

            if (dataToExport.length === 0) return alert("No data matches your filter to export");

            // Build Excel Content (Array of Arrays)
            const exportData = [
                ["Student Tracking Report"],
                ["Generated Date:", new Date().toLocaleDateString()],
                ["Period:", `From: ${startDate}  To: ${endDate}`],
                ["Category Filter:", category],
                [], // Spacer
                ["Student Name", "Category", "Present", "Absent", "Leave", "Total Days"] // Headers (REMOVED ID)
            ];

            dataToExport.forEach(item => {
                exportData.push([
                    item.name,
                    // item.id, // Removed ID as per user request
                    item.category,
                    item.present,
                    item.absent,
                    item.leave,
                    item.total
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);

            // Set column widths
            ws['!cols'] = [
                { wch: 30 }, // Name
                // { wch: 20 }, // ID (Removed)
                { wch: 15 }, // Category
                { wch: 10 }, // Present
                { wch: 10 }, // Absent
                { wch: 10 }, // Leave
                { wch: 12 }  // Total
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tracking Data");

            // Filename with date range
            const filename = `Values_Report_${startDate}_to_${endDate}.xlsx`;
            XLSX.writeFile(wb, filename);
        }


        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('admin-view-reports').style.display = tab === 'reports' ? 'block' : 'none';
            document.getElementById('admin-view-tracking').style.display = tab === 'tracking' ? 'block' : 'none';

            if (tab === 'tracking' && !window.trackingDataCache) {
                fetchTrackingData();
            }
        }

        // Tracking Cache Keys
        const TRACKING_CACHE_KEY = 'hostel_tracking_cache_v2';
        const TRACKING_CACHE_TIME_KEY = 'hostel_tracking_cache_time_v2';

        // Load from browser cache instantly
        function loadTrackingFromCache() {
            try {
                const cached = localStorage.getItem(TRACKING_CACHE_KEY);
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (e) { }
            return null;
        }

        // Save to browser cache
        function saveTrackingToCache(data) {
            try {
                localStorage.setItem(TRACKING_CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(TRACKING_CACHE_TIME_KEY, Date.now().toString());
            } catch (e) { }
        }

        // Get cache age in minutes
        function getTrackingCacheAge() {
            try {
                const time = localStorage.getItem(TRACKING_CACHE_TIME_KEY);
                if (time) {
                    const mins = Math.floor((Date.now() - parseInt(time)) / 60000);
                    return mins;
                }
            } catch (e) { }
            return null;
        }

        async function fetchTrackingData(startDate, endDate) {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');

            // If it's filtered fetch (dates provided), skip cache
            if (startDate || endDate) {
                loader.style.display = 'block';
                content.innerHTML = '';
                await fetchFreshTrackingData(startDate, endDate);
                return;
            }

            // STALE-WHILE-REVALIDATE: Show cached data instantly
            const cachedData = loadTrackingFromCache();
            const cacheAge = getTrackingCacheAge();

            if (cachedData && cachedData.length > 0) {
                window.trackingDataCache = cachedData;
                filterAndRenderTracking();

                // Show cache age indicator
                const ageText = cacheAge !== null ?
                    (cacheAge < 1 ? 'Just now' : `${cacheAge} min ago`) : '';
                if (ageText) {
                    const notice = document.createElement('div');
                    notice.id = 'cacheNotice';
                    notice.style.cssText = 'text-align:center; font-size:12px; color:gray; margin-bottom:8px;';
                    notice.innerHTML = `ðŸ“¦ Showing cached data (${ageText}) - <a href="#" onclick="forceFreshFetch(); return false;" style="color:var(--md-sys-color-primary);">Refresh</a>`;
                    content.insertBefore(notice, content.firstChild);
                }

                // Fetch fresh data in background (if cache > 5 mins old)
                if (cacheAge === null || cacheAge >= 5) {
                    fetchFreshTrackingData(startDate, endDate, true);
                }
            } else {
                // No cache, need to fetch
                loader.style.display = 'block';
                content.innerHTML = '';
                await fetchFreshTrackingData(startDate, endDate);
            }
        }

        async function fetchFreshTrackingData(startDate, endDate, isBackground = false) {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');

            if (!isBackground) {
                loader.style.display = 'block';
            }

            try {
                const payload = { action: "get_tracking_data", sheetUrl: getSessionSheetUrl() };
                if (startDate) payload.startDate = startDate;
                if (endDate) payload.endDate = endDate;

                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.result === 'success') {
                    window.trackingDataCache = json.data;

                    // Save to cache (only if no date filter)
                    if (!startDate && !endDate) {
                        saveTrackingToCache(json.data);
                    }

                    // Remove cache notice if exists
                    const notice = document.getElementById('cacheNotice');
                    if (notice) notice.remove();

                    filterAndRenderTracking();

                    if (isBackground) {
                        showMessage('âœ“ Data updated', 'success');
                    }
                } else if (!isBackground) {
                    content.innerHTML = `<div style="color:red; text-align:center;">Error: ${json.error}</div>`;
                }
            } catch (e) {
                if (!isBackground) {
                    content.innerHTML = `<div style="color:red; text-align:center;">Network Error: ${e.message}</div>`;
                }
            } finally {
                loader.style.display = 'none';
            }
        }

        function forceFreshFetch() {
            const loader = document.getElementById('trackingLoading');
            loader.style.display = 'block';
            fetchFreshTrackingData(null, null);
        }

        async function refreshTrackingData() {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');
            loader.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; color:var(--md-sys-color-primary);">Refreshing & storing data...</div>';

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "refresh_tracking", sheetUrl: getSessionSheetUrl() })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    window.trackingDataCache = json.data;
                    filterAndRenderTracking();
                    showMessage('Tracking data refreshed!', 'success');
                } else {
                    content.innerHTML = `<div style="color:red; text-align:center;">Error: ${json.error}</div>`;
                }
            } catch (e) {
                content.innerHTML = `<div style="color:red; text-align:center;">Network Error: ${e.message}</div>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderTrackingTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('trackingContent').innerHTML = '<div style="text-align:center; padding:20px;">No records found.</div>';
                return;
            }

            let html = `
             <div class="tracking-table-container">
                <table class="tracking-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Category</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Leave</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
             `;

            data.forEach((item, index) => {
                html += `
                    <tr>
                        <td>
                            <div style="font-weight:500; cursor:pointer;" onclick="showStudentDashboard(${index})">${item.name || 'Unknown'}</div>
                            <div style="font-size:12px; color:gray;">${item.category}</div>
                        </td>
                        <td>${item.category}</td>
                        <td><span class="badge present" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'present')">${item.present}</span></td>
                        <td><span class="badge absent" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'absent')">${item.absent}</span></td>
                        <td><span class="badge leave" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'leave')">${item.leave}</span></td>
                        <td><strong>${item.total}</strong></td>
                    </tr>
                 `;
            });

            html += `</tbody></table></div>`;
            document.getElementById('trackingContent').innerHTML = html;
        }

        // Apply date filter - fetches new data from backend
        function filterTrackingData() {
            const startDate = document.getElementById('trackStartDate')?.value || '';
            const endDate = document.getElementById('trackEndDate')?.value || '';

            // Fetch from backend with date filter
            fetchTrackingData(startDate, endDate);
        }

        // Apply local filters (search, category) without backend call
        function filterAndRenderTracking() {
            if (!window.trackingDataCache) return;

            const query = (document.getElementById('trackSearch')?.value || '').toLowerCase();
            const category = document.getElementById('trackCategory')?.value || 'All';

            const filtered = window.trackingDataCache.filter(item => {
                const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                    (item.id && String(item.id).toLowerCase().includes(query));
                const matchesCat = category === 'All' || item.category === category;

                return matchesSearch && matchesCat;
            });

            renderTrackingTable(filtered);
        }

        // --- Student Dashboard Functions ---
        // NOTE: openStudentDashboardFromRanking is defined above (line ~3282)
        // This duplicate was removed to fix the ranking click bug

        function showStudentDashboard(index, focusType) {
            // Get data from filtered view
            const query = document.getElementById('trackSearch')?.value?.toLowerCase() || '';
            const category = document.getElementById('trackCategory')?.value || 'All';

            let dataSource = window.trackingDataCache || [];
            if (query || category !== 'All') {
                dataSource = dataSource.filter(item => {
                    const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                        (item.id && String(item.id).toLowerCase().includes(query));
                    const matchesCat = category === 'All' || item.category === category;
                    return matchesSearch && matchesCat;
                });
            }

            const student = dataSource[index];
            if (!student) return;

            // Update modal header
            document.getElementById('dashboardStudentName').textContent = student.name;
            document.getElementById('dashboardCategory').textContent = student.category;

            // Update summary counts
            document.getElementById('dashPresent').textContent = student.present || 0;
            document.getElementById('dashAbsent').textContent = student.absent || 0;
            document.getElementById('dashLeave').textContent = student.leave || 0;

            // Build date details HTML
            let detailsHtml = '';

            // Present dates
            detailsHtml += buildDateSection('âœ… Present Days', student.presentDates || [], 'present', focusType === 'present', student.present);

            // Absent dates
            detailsHtml += buildDateSection('âŒ Absent Days', student.absentDates || [], 'absent', focusType === 'absent', student.absent);

            // Leave dates
            detailsHtml += buildDateSection('ðŸŸ¡ Leave Days', student.leaveDates || [], 'leave', focusType === 'leave', student.leave);

            document.getElementById('dashboardDateDetails').innerHTML = detailsHtml;

            // Show modal
            const modal = document.getElementById('studentDashboardModal');
            modal.style.display = 'flex';
        }

        function buildDateSection(title, dates, type, isExpanded, count) {
            const icons = {
                present: 'âœ“',
                absent: 'âœ—',
                leave: 'â—‹'
            };
            const iconColors = {
                present: '#34C759',
                absent: '#FF3B30',
                leave: '#FF9500'
            };
            const icon = icons[type] || icons.present;
            const iconColor = iconColors[type] || iconColors.present;
            const actualCount = count || (dates ? dates.length : 0);

            // Simple iOS style header
            const headerHtml = `
                <div style="display:flex; align-items:center; gap:8px; padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.06);">
                    <span style="color:${iconColor}; font-size:16px; font-weight:600;">${icon}</span>
                    <span style="font-size:15px; font-weight:500; color:#1C1C1E;">${title.replace(/[âœ…âŒðŸŸ¡]/g, '').trim()}</span>
                    <span style="margin-left:auto; font-size:15px; color:#8E8E93;">${actualCount}</span>
                </div>
            `;

            if (!dates || dates.length === 0) {
                if (actualCount > 0) {
                    return `
                        <div style="margin-bottom:8px;">
                            ${headerHtml}
                            <div style="color:#8E8E93; font-size:13px; padding:12px 0;">
                                Redeploy to see dates
                            </div>
                        </div>
                    `;
                }
                return `
                    <div style="margin-bottom:8px;">
                        ${headerHtml}
                        <div style="color:#8E8E93; font-size:13px; padding:12px 0;">
                            No records
                        </div>
                    </div>
                `;
            }

            // Simple comma-separated dates list
            const allDatesStr = dates.map(d => formatDateShort(d)).join(', ');
            const shortDatesStr = dates.slice(0, 7).map(d => formatDateShort(d)).join(', ');
            const hasMore = dates.length > 7 && !isExpanded;
            const sectionId = `dates-section-${type}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

            if (hasMore) {
                return `
                    <div style="margin-bottom:8px;">
                        ${headerHtml}
                        <div id="${sectionId}" style="color:#3C3C43; font-size:14px; padding:12px 0; line-height:1.5;">
                            ${shortDatesStr} <span onclick="document.getElementById('${sectionId}').innerHTML='${allDatesStr.replace(/'/g, "\\'")}'" style="color:#007AFF; cursor:pointer;">+${dates.length - 7} more</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div style="margin-bottom:8px;">
                    ${headerHtml}
                    <div style="color:#3C3C43; font-size:14px; padding:12px 0; line-height:1.5;">
                        ${allDatesStr}
                    </div>
                </div>
            `;
        }

        function formatDateShort(dateStr) {
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getDate()}`;
            } catch (e) {
                return dateStr;
            }
        }

        function closeStudentDashboard() {
            document.getElementById('studentDashboardModal').style.display = 'none';
        }

        async function fetchAndDownloadReport() {
            const date = document.getElementById('reportDate').value;
            if (!date) return;

            const msg = document.getElementById('adminMsg');
            msg.textContent = "Fetching from Google Sheet...";
            msg.style.color = "blue";

            try {
                // Use text/plain to avoid preflight options failure
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "fetch_reports", date: date, sheetUrl: getSessionSheetUrl() })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    msg.textContent = "Generating Excel...";
                    generateReportExcel(json.data, date);
                    msg.textContent = "Download Started!";
                    msg.style.color = "green";
                } else {
                    msg.textContent = "Error: " + json.error;
                    msg.style.color = "red";
                }
            } catch (e) {
                msg.textContent = "Network Error: " + e.message;
                msg.style.color = "red";
            }
        }

        function generateReportExcel(data, date) {
            const wb = XLSX.utils.book_new();
            let hasData = false;

            // Helper to clean date format (ISO to YYYY-MM-DD)
            function cleanDate(dateVal) {
                if (!dateVal) return '';
                const str = String(dateVal);
                // If ISO format with T, extract just the date part
                if (str.includes('T')) {
                    return str.split('T')[0];
                }
                return str;
            }

            for (const [sheetName, rows] of Object.entries(data)) {
                if (rows && rows.length > 0) {
                    hasData = true;

                    // Clean date in each row (Date is usually the last column)
                    const cleanedRows = rows.map((row, rowIndex) => {
                        if (rowIndex === 0) return row; // Keep header as is
                        return row.map((cell, colIndex) => {
                            // Check if it looks like a date
                            const str = String(cell);
                            if (str.includes('T') && str.includes('-')) {
                                return cleanDate(cell);
                            }
                            return cell;
                        });
                    });

                    const ws = XLSX.utils.aoa_to_sheet(cleanedRows);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }

            if (!hasData) {
                alert("No data found for this date.");
                return;
            }

            XLSX.writeFile(wb, `Attendance_Report_${date}.xlsx`);
        }


        // Quick Daily Report Dialog (opens from drawer)
        function openQuickDailyReportDialog() {
            closeDrawer();

            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'quickReportOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];

            overlay.innerHTML = `
                <div style="
                    background: var(--md-sys-color-surface);
                    border-radius: 24px;
                    padding: 24px;
                    width: 100%;
                    max-width: 340px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                ">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--md-sys-color-primary);">
                        ðŸ“¥ Quick Daily Report
                    </h3>
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); font-weight: 500;">
                            Select Date
                        </label>
                        <input type="date" id="quickReportDate" value="${today}" 
                            style="
                                width: 100%;
                                padding: 12px;
                                margin-top: 8px;
                                border: 1px solid var(--md-sys-color-outline);
                                border-radius: 12px;
                                font-size: 16px;
                                background: var(--md-sys-color-surface);
                                color: var(--md-sys-color-on-surface);
                            ">
                    </div>
                    <div id="quickReportMsg" style="min-height: 20px; font-size: 13px; margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeQuickReportDialog()" 
                            style="
                                flex: 1;
                                padding: 14px;
                                border: 1px solid var(--md-sys-color-outline);
                                border-radius: 12px;
                                background: transparent;
                                color: var(--md-sys-color-on-surface);
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                            ">Cancel</button>
                        <button onclick="downloadQuickReport()" 
                            style="
                                flex: 1;
                                padding: 14px;
                                border: none;
                                border-radius: 12px;
                                background: var(--md-sys-color-primary);
                                color: white;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                            ">Download</button>
                    </div>
                </div>
            `;

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeQuickReportDialog();
            });

            document.body.appendChild(overlay);
        }

        function closeQuickReportDialog() {
            const overlay = document.getElementById('quickReportOverlay');
            if (overlay) overlay.remove();
        }

        async function downloadQuickReport() {
            const dateInput = document.getElementById('quickReportDate');
            const msg = document.getElementById('quickReportMsg');
            const date = dateInput.value;

            if (!date) {
                msg.textContent = "Please select a date";
                msg.style.color = "red";
                return;
            }

            msg.textContent = "Fetching from Google Sheet...";
            msg.style.color = "var(--md-sys-color-primary)";

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "fetch_reports", date: date, sheetUrl: getSessionSheetUrl() })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    msg.textContent = "Generating Excel...";

                    // Format date as DD-MM-YYYY for filename
                    const [year, month, day] = date.split('-');
                    const formattedDate = `${day}-${month}-${year}`;

                    generateReportExcel(json.data, formattedDate);

                    msg.textContent = "Download Started! âœ…";
                    msg.style.color = "green";

                    setTimeout(() => closeQuickReportDialog(), 1500);
                } else {
                    msg.textContent = "Error: " + (json.error || "No data found");
                    msg.style.color = "red";
                }
            } catch (e) {
                msg.textContent = "Network Error: " + e.message;
                msg.style.color = "red";
            }
        }


        function downloadTrackingPDF() {
            if (!window.trackingDataCache || window.trackingDataCache.length === 0) {
                return alert("No tracking data available. Please load data first.");
            }

            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    return alert("PDF Library not loaded yet. Please wait a moment or reload the page.");
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Safe element access with fallbacks
                const searchEl = document.getElementById('trackSearch');
                const categoryEl = document.getElementById('trackCategory');
                const startDateEl = document.getElementById('trackStartDate');
                const endDateEl = document.getElementById('trackEndDate');

                const query = searchEl ? searchEl.value.toLowerCase() : '';
                const category = categoryEl ? categoryEl.value : 'All';
                const startDate = startDateEl ? (startDateEl.value || "All Time") : "All Time";
                const endDate = endDateEl ? (endDateEl.value || "Present") : "Present";

                // Filter data
                const dataToExport = window.trackingDataCache.filter(item => {
                    const matchesSearch = !query || (item.name && item.name.toLowerCase().includes(query)) ||
                        (item.id && String(item.id).toLowerCase().includes(query));
                    const matchesCat = category === 'All' || item.category === category;
                    return matchesSearch && matchesCat;
                });

                if (dataToExport.length === 0) {
                    return alert("No data to export.");
                }

                // Header Info
                doc.setFontSize(18);
                doc.setTextColor(0, 122, 255);
                doc.text("Student Tracking Report", 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
                doc.text(`Period: ${startDate} to ${endDate}`, 14, 35);
                doc.text(`Category: ${category}`, 14, 40);
                doc.text(`Total Students: ${dataToExport.length}`, 14, 45);

                // Table Data with scores
                const tableBody = dataToExport.map(item => {
                    const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                    return [
                        item.name,
                        item.category,
                        item.present,
                        item.absent,
                        item.leave,
                        item.total,
                        score + '%'
                    ];
                });

                doc.autoTable({
                    startY: 50,
                    head: [['Student Name', 'Category', 'Present', 'Absent', 'Leave', 'Total', 'Score']],
                    body: tableBody,
                    theme: 'striped',
                    headStyles: { fillColor: [0, 122, 255] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 45 },
                        1: { cellWidth: 25 },
                        6: { halign: 'center', fontStyle: 'bold' }
                    }
                });

                const filename = `Tracking_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                showMessage('PDF Downloaded!', 'success');
            } catch (e) {
                alert("PDF Error: " + e.message);
                console.error(e);
            }
        }

        // ========================================
        // iOS AssistiveTouch Floating Button
        // ========================================
        (function () {
            const btn = document.getElementById('assistiveTouchBtn');
            const menu = document.getElementById('assistiveTouchMenu');
            const overlay = document.getElementById('assistiveTouchOverlay');
            const menuItems = document.querySelectorAll('.assistive-menu-item');

            if (!btn || !menu || !overlay) return;

            let isDragging = false;
            let hasMoved = false;
            let startX, startY, initialX, initialY;
            const DRAG_THRESHOLD = 10;

            // Get initial position
            initialX = btn.offsetLeft;
            initialY = btn.offsetTop;

            // Touch Events
            btn.addEventListener('touchstart', handleDragStart, { passive: false });
            btn.addEventListener('touchmove', handleDragMove, { passive: false });
            btn.addEventListener('touchend', handleDragEnd);

            // Mouse Events (for desktop testing)
            btn.addEventListener('mousedown', handleDragStart);
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);

            function handleDragStart(e) {
                if (menu.classList.contains('visible')) return;

                isDragging = true;
                hasMoved = false;

                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                startY = touch.clientY;
                initialX = btn.offsetLeft;
                initialY = btn.offsetTop;

                btn.style.transition = 'none';
            }

            function handleDragMove(e) {
                if (!isDragging) return;

                const touch = e.touches ? e.touches[0] : e;
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;

                // Check if moved beyond threshold
                if (Math.abs(deltaX) > DRAG_THRESHOLD || Math.abs(deltaY) > DRAG_THRESHOLD) {
                    hasMoved = true;
                    btn.classList.add('dragging');

                    // Calculate new position
                    let newX = initialX + deltaX;
                    let newY = initialY + deltaY;

                    // Constrain to viewport
                    const maxX = window.innerWidth - btn.offsetWidth - 8;
                    const maxY = window.innerHeight - btn.offsetHeight - 8;
                    newX = Math.max(8, Math.min(newX, maxX));
                    newY = Math.max(8, Math.min(newY, maxY));

                    btn.style.left = newX + 'px';
                    btn.style.top = newY + 'px';
                    btn.style.right = 'auto';
                    btn.style.bottom = 'auto';

                    e.preventDefault();
                }
            }

            function handleDragEnd(e) {
                if (!isDragging) return;

                isDragging = false;
                btn.classList.remove('dragging');
                btn.style.transition = '';

                // If not moved, treat as tap
                if (!hasMoved) {
                    toggleMenu();
                } else {
                    // Snap to nearest horizontal edge
                    snapToEdge();
                }
            }

            function snapToEdge() {
                const btnRect = btn.getBoundingClientRect();
                const centerX = btnRect.left + btnRect.width / 2;
                const screenMidX = window.innerWidth / 2;

                btn.style.transition = 'left 0.3s cubic-bezier(0.32, 0.72, 0, 1), right 0.3s cubic-bezier(0.32, 0.72, 0, 1)';

                if (centerX < screenMidX) {
                    // Snap to left
                    btn.style.left = '16px';
                    btn.style.right = 'auto';
                } else {
                    // Snap to right
                    btn.style.left = 'auto';
                    btn.style.right = '16px';
                }
            }

            function toggleMenu() {
                const isOpen = menu.classList.contains('visible');

                if (isOpen) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }

            function openMenu() {
                // Position menu near button
                const btnRect = btn.getBoundingClientRect();
                const menuWidth = 220;
                const menuHeight = 220;

                let menuX = btnRect.left - menuWidth - 16;
                let menuY = btnRect.top - menuHeight / 2 + btnRect.height / 2;

                // If button is on left side, show menu on right
                if (btnRect.left < window.innerWidth / 2) {
                    menuX = btnRect.right + 16;
                    menu.style.transformOrigin = 'left center';
                } else {
                    menu.style.transformOrigin = 'right center';
                }

                // Constrain to viewport
                menuX = Math.max(16, Math.min(menuX, window.innerWidth - menuWidth - 16));
                menuY = Math.max(80, Math.min(menuY, window.innerHeight - menuHeight - 16));

                menu.style.left = menuX + 'px';
                menu.style.top = menuY + 'px';

                // Show menu and overlay
                menu.classList.add('visible');
                overlay.classList.add('visible');
                btn.classList.add('menu-open');
            }

            function closeMenu() {
                menu.classList.remove('visible');
                overlay.classList.remove('visible');
                btn.classList.remove('menu-open');
            }

            // Close menu when clicking overlay
            overlay.addEventListener('click', closeMenu);

            // Menu item click handlers
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const category = this.getAttribute('data-category');
                    if (category && typeof switchCategory === 'function') {
                        switchCategory(category);
                    }
                    closeMenu();
                });
            });
        })();

    </script>
</body>

</html>